<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Life Quest Engine v2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f2a93;
            --accent: #ffbe5c;
            --danger: #ff6b6b;
            --success: #4caf50;
            --bg: #f0f2f5;
            --card-bg: #fff;
            --text: #333;
            --nav-base-height: 60px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --nav-height: calc(var(--nav-base-height) + var(--safe-area-bottom));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: calc(var(--nav-height) + 80px); 
            overscroll-behavior-y: none;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            padding-top: 10px;
        }

        /* --- Tablet & Desktop Tweaks --- */
        @media (min-width: 768px) {
            .container { max-width: 900px; }
            .task-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .task-item { margin-bottom: 0 !important; height: 100%; }
            .bottom-nav {
                width: 400px !important; left: 50% !important; transform: translateX(-50%);
                bottom: 20px !important; border-radius: 50px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.15) !important; padding-bottom: 0 !important; height: 60px !important;
            }
            .quick-add-bar { width: 500px !important; bottom: 100px !important; }
        }

        /* --- Header --- */
        header {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 20px;
            position: sticky; top: 10px; z-index: 90;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .progress-bar { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin-top: 12px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- Tabs --- */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* --- Task Lists --- */
        .section-title {
            font-size: 0.95rem; color: #666; margin: 25px 0 10px 5px; font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.1s; border-left: 5px solid transparent; min-height: 60px;
        }
        .task-item:active { transform: scale(0.98); background: #f9f9f9; }
        .task-item.long-term { border-left-color: var(--primary); }
        .task-item.short-term { border-left-color: #aaa; }
        .task-item.gacha-task { border-left-color: var(--accent); background: #fffbf0; }
        .task-item.completed { opacity: 0.6; background: #f4f4f4; }
        .task-item.completed .task-text { text-decoration: line-through; color: #999; }
        .task-text { flex-grow: 1; margin-left: 12px; font-size: 1rem; line-height: 1.4; word-break: break-word; }
        .task-tag { font-size: 0.75rem; padding: 3px 8px; background: #eee; border-radius: 6px; color: #555; margin-right: 6px; }

        input[type="checkbox"] { width: 24px; height: 24px; border: 2px solid #ddd; border-radius: 50%; appearance: none; -webkit-appearance: none; flex-shrink: 0; position: relative;}
        input[type="checkbox"]:checked { background: var(--success); border-color: var(--success); }
        input[type="checkbox"]:checked::after { content: 'âœ“'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        
        .delete-btn { padding: 10px; color: #ccc; margin-left: 5px; }

        /* --- Gacha Page --- */
        .gacha-container { text-align: center; padding: 20px 10px; }
        .gacha-machine { font-size: 6rem; color: var(--primary); margin-bottom: 20px; animation: float 3s infinite ease-in-out; }
        .gacha-btn {
            background: var(--accent); color: #7a4e00; font-size: 1.2rem; padding: 15px 40px;
            border-radius: 50px; border: none; box-shadow: 0 6px 0 #d49e3b; cursor: pointer; font-weight: 800;
            width: 100%; max-width: 300px;
        }
        .gacha-btn:active { transform: translateY(6px); box-shadow: none; }
        
        .gacha-result-card {
            border: 2px solid var(--accent); background: #fffdf5; padding: 25px; margin-top: 30px;
            border-radius: 16px; display: none; animation: fadeIn 0.5s; text-align: left;
        }

        /* --- Custom Pool UI --- */
        .pool-list { list-style: none; padding: 0; text-align: left; margin-top: 10px;}
        .pool-item { 
            background: white; border-bottom: 1px solid #eee; padding: 12px; display: flex; 
            justify-content: space-between; align-items: center; font-size: 0.9rem;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: flex-start;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
            padding-bottom: var(--safe-area-bottom); border-top: 1px solid rgba(0,0,0,0.05);
        }
        .nav-item { flex: 1; text-align: center; color: #aaa; padding-top: 10px; font-size: 0.75rem; }
        .nav-item i { display: block; font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }

        /* --- Quick Add Bar --- */
        .quick-add-bar {
            position: fixed; bottom: calc(var(--nav-height) + 15px); left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px; display: flex; gap: 10px;
            background: rgba(255,255,255,0.95); padding: 10px; border-radius: 16px;
            backdrop-filter: blur(8px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); z-index: 99;
        }
        .quick-add-bar input { flex-grow: 1; padding: 12px 15px; border: 1px solid #eee; border-radius: 10px; background: #f9f9f9; outline: none; font-size: 16px; }

        /* --- Settings & Modals --- */
        .settings-list { list-style: none; padding: 0; }
        .settings-item { background: white; padding: 18px; margin-bottom: 8px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px;
        }
        .modal { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 360px; text-align: center; position: relative;}
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { border: 1px solid #ccc; background: none; color: #666; }
        
        .close-modal-btn {
            position: absolute; top: 10px; right: 10px; width: 30px; height: 30px;
            background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #666; font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-top">
                <div style="font-weight: 800; color: var(--primary); font-size: 1.1rem;">
                    <i class="fas fa-dragon"></i> Life Quest v2
                </div>
                <button onclick="startCooldown()" class="btn btn-danger" style="font-size: 0.8rem; padding: 6px 12px;">
                    <i class="fas fa-fire"></i> å†·éœ
                </button>
            </div>
            <div class="progress-bar">
                <div id="main-progress" class="progress-fill"></div>
            </div>
            <div style="text-align: right; font-size: 0.8rem; color: #888; margin-top: 8px;">
                ä¿®ç…‰é€²åº¦: <span id="progress-text">0%</span>
            </div>
        </header>

        <div id="tab-dashboard" class="tab-content active">
            <div class="section-title">
                <span><i class="fas fa-infinity" style="color:var(--primary)"></i> é•·æœŸä¿®ç…‰</span>
                <small onclick="switchTab('settings')" style="cursor:pointer; color:var(--primary); background:rgba(79, 42, 147, 0.1); padding:4px 8px; border-radius:6px;">ç®¡ç† ></small>
            </div>
            <ul id="long-term-list" class="task-list"></ul>
            <div id="long-term-empty" style="text-align:center; color:#999; font-size:0.9rem; padding: 20px; background:rgba(255,255,255,0.5); border-radius:12px; display:none;">
                å°šç„¡é …ç›®ï¼Œè«‹è‡³è¨­å®šé æ–°å¢
            </div>

            <div class="section-title" style="margin-top: 30px;">
                <span><i class="fas fa-bolt" style="color:#f57c00"></i> çŸ­æœŸä»»å‹™</span>
            </div>
            <ul id="short-term-list" class="task-list" style="margin-bottom: 80px;"></ul>
            
            <div class="quick-add-bar">
                <input type="text" id="quick-input" placeholder="æ–°å¢ä»»å‹™..." enterkeyhint="done" onkeypress="handleQuickAdd(event)">
                <button onclick="addShortTermTask()" class="btn btn-primary" style="padding: 0 15px;"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>

        <div id="tab-gacha" class="tab-content">
            <div class="gacha-container">
                <h2 style="font-size:1.8rem; margin-top:0;">å‘½é‹æŠ½ç±¤</h2>
                <div id="gacha-icon" class="gacha-machine"><i class="fas fa-gift"></i></div>
                <button onclick="playGacha()" class="gacha-btn">é–‹å§‹æŠ½å–</button>

                <div id="gacha-result" class="gacha-result-card">
                    <h3 id="gacha-title" style="color:var(--primary); margin-top:0;"></h3>
                    <p id="gacha-desc" style="color:#444; margin:10px 0 20px 0;"></p>
                    <button onclick="acceptGacha()" class="btn btn-primary" style="width:100%; margin-bottom:10px;">æ¥å—æŒ‘æˆ°</button>
                    <button onclick="closeGachaResult()" class="btn btn-outline" style="width:100%;">é—œé–‰</button>
                </div>

                <div style="margin-top: 50px; border-top: 2px dashed #ddd; padding-top: 20px;">
                    <div class="section-title"><span><i class="fas fa-plus-circle"></i> è‡ªè¨‚æŒ‘æˆ°æ± </span></div>
                    <div style="background: white; padding: 15px; border-radius: 12px; text-align: left;">
                        <input type="text" id="pool-title" placeholder="æ¨™é¡Œ (ä¾‹: Habitica-æ•´ç†æ›¸æ¡Œ)" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #eee; border-radius:8px;">
                        <input type="text" id="pool-desc" placeholder="æè¿° (ä¾‹: èŠ±15åˆ†é˜æ•´ç†)" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #eee; border-radius:8px;">
                        <button onclick="addToPool()" class="btn btn-primary" style="width:100%;">åŠ å…¥æŠ½ç±¤æ± </button>
                    </div>
                    
                    <div style="margin-top:20px; text-align: left;">
                        <div style="font-size:0.8rem; color:#999; margin-bottom:5px;">ç›®å‰æ± ä¸­çš„æŒ‘æˆ°ï¼š</div>
                        <ul id="pool-display-list" class="pool-list"></ul>
                        <button onclick="resetPool()" style="margin-top:10px; color:#999; background:none; border:none; text-decoration:underline;">é‡ç½®å›é è¨­å€¼</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="section-title"><span>é•·æœŸä»»å‹™æ¨¡æ¿</span></div>
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="setting-input" placeholder="è¼¸å…¥ç¿’æ…£..." style="flex:1; padding:12px; border:1px solid #eee; border-radius:8px; font-size:16px;">
                    <button onclick="addSettingTemplate()" class="btn btn-primary">æ–°å¢</button>
                </div>
            </div>
            <ul id="settings-list" class="settings-list"></ul>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="deployLongTermTasks()" class="btn btn-primary" style="width: 100%; padding: 15px;">
                    <i class="fas fa-sync-alt"></i> å…¨éƒ¨éƒ¨ç½²åˆ°å„€è¡¨æ¿
                </button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-list-ul"></i> å„€è¡¨æ¿</div>
        <div class="nav-item" onclick="switchTab('gacha')"><i class="fas fa-dice-d20"></i> æŠ½ç±¤</div>
        <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i> è¨­å®š</div>
    </nav>

    <div id="cooldown-modal" class="modal-overlay">
        <div class="modal">
            <div class="close-modal-btn" onclick="stopCooldown(true)">&times;</div>
            
            <h2 style="color: var(--danger); font-size:2rem; margin-bottom:10px;">ğŸ”¥ ç³»çµ±éç†±</h2>
            <p style="color:#666; margin-bottom:20px;">æ·±å‘¼å¸ï¼Œä»€éº¼éƒ½ä¸ç”¨åšã€‚</p>
            <div id="timer-display" style="font-size: 3.5rem; font-weight: 800; color:#333; margin: 20px 0;">03:00</div>
            <textarea id="anger-log" placeholder="åœ¨æ­¤å®£æ´©æƒ…ç·’ (ä¸æœƒä¿å­˜)..." style="width: 100%; height: 100px; padding: 15px; border-radius:10px; border:1px solid #ddd;"></textarea>
            <button onclick="stopCooldown(false)" id="stop-cooldown-btn" class="btn btn-outline" disabled style="width: 100%; margin-top:15px;">å†·å»ä¸­...</button>
        </div>
    </div>

    <script>
        /* --- Data & State --- */
        let tasks = JSON.parse(localStorage.getItem('myTasks')) || [];
        let longTermTemplates = JSON.parse(localStorage.getItem('longTermTemplates')) || [
            { text: "é–±è®€ 30 åˆ†é˜", tag: "Learning" },
            { text: "é‹å‹•/ä¼¸å±•", tag: "Health" }
        ];

        // ä¿®æ­£ 3: å°‡ Gacha Pool æ”¹ç‚ºå¯å¾ LocalStorage è®€å–
        const defaultPool = [
            { title: "ğŸ“µ æ•¸ä½æ’æ¯’", desc: "æ¥ä¸‹ä¾† 1 å°æ™‚ä¸çœ‹æ‰‹æ©Ÿç¤¾ç¾¤è»Ÿé«”" },
            { title: "ğŸ’§ æ°´ä¹‹å‘¼å¸", desc: "ç«‹åˆ»å»å– 500cc çš„æ°´" },
            { title: "ğŸ§˜ å†¥æƒ³æ™‚åˆ»", desc: "é–‰ä¸Šçœ¼ç›ï¼Œä»€éº¼éƒ½ä¸åš 2 åˆ†é˜" },
            { title: "ğŸ“ å¯«ä¸‹æƒ…ç·’", desc: "åœ¨ç­†è¨˜æœ¬å¯«ä¸‹ç›®å‰çš„ä¸€å€‹ç„¦æ…®ï¼Œç„¶å¾ŒåŠƒæ‰å®ƒ" }
        ];
        let gachaPool = JSON.parse(localStorage.getItem('gachaPool')) || defaultPool;
        let currentGachaResult = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderTasks();
            renderSettingsList();
            renderPoolList(); // æ¸²æŸ“è‡ªè¨‚æŒ‘æˆ°æ± æ¸…å–®
        });

        /* --- Tab Switching --- */
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            const tabs = ['dashboard', 'gacha', 'settings'];
            document.querySelectorAll('.nav-item')[tabs.indexOf(tabName)].classList.add('active');
            window.scrollTo(0, 0);
        }

        /* --- Core Task Logic --- */
        function renderTasks() {
            const longList = document.getElementById('long-term-list');
            const shortList = document.getElementById('short-term-list');
            longList.innerHTML = ''; shortList.innerHTML = '';
            
            let hasLongTerm = false;
            let completed = tasks.filter(t => t.completed).length;

            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `task-item ${task.type} ${task.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.id}')">
                    <div class="task-text" onclick="toggleTask('${task.id}')">
                        ${task.tag ? `<span class="task-tag">${task.tag}</span>` : ''}
                        <span>${task.text}</span>
                    </div>
                    <div class="delete-btn" onclick="deleteTask('${task.id}')"><i class="fas fa-times"></i></div>
                `;
                if (task.type === 'long-term') { longList.appendChild(li); hasLongTerm = true; } 
                else { shortList.appendChild(li); }
            });

            document.getElementById('long-term-empty').style.display = hasLongTerm ? 'none' : 'block';
            const percent = tasks.length === 0 ? 0 : Math.round((completed / tasks.length) * 100);
            document.getElementById('main-progress').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${completed}/${tasks.length} (${percent}%)`;
        }

        function addTask(text, type, tag = "") {
            tasks.push({ id: Date.now().toString(36), text, type, tag, completed: false });
            saveTasks(); renderTasks();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function handleQuickAdd(e) { if (e.key === 'Enter') { e.preventDefault(); addShortTermTask(); } }
        function addShortTermTask() {
            const input = document.getElementById('quick-input');
            if (input.value.trim()) {
                addTask(input.value.trim(), 'short-term', 'ToDo');
                input.value = ''; input.blur(); switchTab('dashboard');
            }
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) { task.completed = !task.completed; saveTasks(); renderTasks(); }
        }
        function deleteTask(id) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { tasks = tasks.filter(t => t.id !== id); saveTasks(); renderTasks(); }
        }
        function saveTasks() { localStorage.setItem('myTasks', JSON.stringify(tasks)); }

        /* --- Settings Logic --- */
        function renderSettingsList() {
            const list = document.getElementById('settings-list'); list.innerHTML = '';
            longTermTemplates.forEach((item, index) => {
                list.innerHTML += `<li class="settings-item"><span>${item.text} <small>${item.tag}</small></span><button onclick="removeTemplate(${index})" class="btn btn-outline" style="color:#ff6b6b;"><i class="fas fa-trash"></i></button></li>`;
            });
        }
        function addSettingTemplate() {
            const input = document.getElementById('setting-input');
            if (input.value.trim()) {
                longTermTemplates.push({ text: input.value.trim(), tag: 'Routine' });
                localStorage.setItem('longTermTemplates', JSON.stringify(longTermTemplates));
                input.value = ''; renderSettingsList();
            }
        }
        function removeTemplate(index) {
            longTermTemplates.splice(index, 1);
            localStorage.setItem('longTermTemplates', JSON.stringify(longTermTemplates));
            renderSettingsList();
        }
        function deployLongTermTasks() {
            if(confirm('éƒ¨ç½²æ‰€æœ‰ç¿’æ…£åˆ°ä»Šæ—¥åˆ—è¡¨ï¼Ÿ')) {
                longTermTemplates.forEach(t => addTask(t.text, 'long-term', t.tag));
                switchTab('dashboard');
            }
        }

        /* --- Gacha Logic (Enhanced) --- */
        function playGacha() {
            const icon = document.getElementById('gacha-icon');
            const resultCard = document.getElementById('gacha-result');
            resultCard.style.display = 'none';
            icon.style.animation = 'shake 0.5s infinite';
            if(navigator.vibrate) navigator.vibrate(200);

            setTimeout(() => {
                icon.style.animation = 'float 3s infinite ease-in-out';
                // é€™è£¡å°±æ˜¯éš¨æ©Ÿæ©Ÿåˆ¶çš„æ ¸å¿ƒï¼š
                const random = gachaPool[Math.floor(Math.random() * gachaPool.length)];
                currentGachaResult = random;
                
                document.getElementById('gacha-title').innerText = random.title;
                document.getElementById('gacha-desc').innerText = random.desc;
                resultCard.style.display = 'block';
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }, 800);
        }

        function acceptGacha() {
            if (currentGachaResult) {
                addTask(`${currentGachaResult.title}: ${currentGachaResult.desc}`, 'gacha-task', 'Challenge');
                switchTab('dashboard');
                closeGachaResult();
            }
        }
        function closeGachaResult() { document.getElementById('gacha-result').style.display = 'none'; }

        // --- æ–°å¢åŠŸèƒ½ï¼šè‡ªè¨‚æŒ‘æˆ°æ± é‚è¼¯ ---
        function renderPoolList() {
            const list = document.getElementById('pool-display-list');
            list.innerHTML = '';
            gachaPool.forEach((item, index) => {
                list.innerHTML += `
                <li class="pool-item">
                    <div><b>${item.title}</b><br><small style="color:#777">${item.desc}</small></div>
                    <i class="fas fa-trash" onclick="removeFromPool(${index})" style="color:#ddd; padding:5px; cursor:pointer;"></i>
                </li>`;
            });
        }

        function addToPool() {
            const title = document.getElementById('pool-title');
            const desc = document.getElementById('pool-desc');
            if(title.value.trim()) {
                gachaPool.push({ title: title.value.trim(), desc: desc.value.trim() || 'è‡ªè¨‚æŒ‘æˆ°' });
                localStorage.setItem('gachaPool', JSON.stringify(gachaPool));
                title.value = ''; desc.value = '';
                renderPoolList();
                alert('å·²åŠ å…¥æŠ½ç±¤æ± ï¼');
            }
        }

        function removeFromPool(index) {
            if(confirm('å¾æ± ä¸­ç§»é™¤æ­¤æŒ‘æˆ°ï¼Ÿ')) {
                gachaPool.splice(index, 1);
                if(gachaPool.length === 0) gachaPool = defaultPool; // é¿å…ç©ºæ± 
                localStorage.setItem('gachaPool', JSON.stringify(gachaPool));
                renderPoolList();
            }
        }

        function resetPool() {
            if(confirm('é‡ç½®ç‚ºç³»çµ±é è¨­æŒ‘æˆ°ï¼Ÿ')) {
                gachaPool = JSON.parse(JSON.stringify(defaultPool)); // Deep copy
                localStorage.setItem('gachaPool', JSON.stringify(gachaPool));
                renderPoolList();
            }
        }

        /* --- Cooldown Logic (Fixed) --- */
        let cooldownTimer = null;
        function startCooldown() {
            const modal = document.getElementById('cooldown-modal');
            const btn = document.getElementById('stop-cooldown-btn');
            modal.style.display = 'flex';
            
            let timeLeft = 180; 
            updateTimerDisplay(timeLeft);
            
            btn.disabled = true;
            btn.innerText = "å†·å»ä¸­...";
            
            if(cooldownTimer) clearInterval(cooldownTimer);
            cooldownTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(cooldownTimer);
                    btn.disabled = false;
                    btn.innerText = "å®Œæˆå†·å» (é›¢é–‹)";
                    if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }

        function stopCooldown(force = false) {
            if (force || !document.getElementById('stop-cooldown-btn').disabled) {
                document.getElementById('cooldown-modal').style.display = 'none';
                clearInterval(cooldownTimer);
                document.getElementById('anger-log').value = '';
            }
        }
    </script>
</body>
</html>
