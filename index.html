<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Quest v8.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50; --accent: #e67e22; 
            --habit: #f1c40f; --daily: #3498db; --todo: #e67e22;
            --bg: #dfe6e9; --text: #2d3436;
            --glass: rgba(255, 255, 255, 0.95);
            --radius: 12px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* --- 1. OPTIMIZED CANVAS (Background) --- */
        #world {
            position: fixed; top: 0; left: 0; width: 100%; height: 45vh; z-index: 0;
            background: linear-gradient(to bottom, #89f7fe, #66a6ff); /* Static CSS gradient is faster than Canvas gradient */
        }

        /* --- 2. LAYOUT --- */
        .app-layout { position: relative; z-index: 10; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Spacer to show the tower */
        .tower-view { height: 40vh; transition: height 0.3s; cursor: pointer; }
        .tower-view.collapsed { height: 10vh; }

        .main-sheet {
            flex: 1; background: var(--glass); 
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            min-height: 60vh;
        }

        /* --- 3. PROFILE & BADGES (New Feature) --- */
        .profile-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .stats-box { flex: 1; }
        .stats-title { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }
        .stats-number { font-size: 2rem; font-weight: 800; color: var(--primary); }
        
        .badge-rack { 
            display: flex; gap: 5px; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 20px; 
        }
        .badge { 
            width: 30px; height: 30px; border-radius: 50%; background: #ccc; 
            display: flex; justify-content: center; align-items: center; font-size: 1rem;
            filter: grayscale(100%); opacity: 0.5; transition: all 0.5s;
        }
        .badge.unlocked { filter: grayscale(0%); opacity: 1; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: scale(1.1); }

        /* --- 4. DASHBOARD GRID (v7.0 Layout) --- */
        .grid-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .col-card { background: #f1f2f6; padding: 10px; border-radius: var(--radius); }
        .col-header { display: flex; justify-content: space-between; font-weight: bold; color: #636e72; padding: 5px; font-size: 0.9rem; }
        
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px;
            display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 4px solid transparent; transition: 0.2s;
        }
        .type-habit { border-left-color: var(--habit); }
        .type-daily { border-left-color: var(--daily); }
        .type-todo { border-left-color: var(--todo); }
        
        .check-box { width: 20px; height: 20px; background: #eee; border-radius: 4px; margin-right: 10px; cursor: pointer; flex-shrink: 0; }
        .type-habit .check-box { background: var(--habit); }
        .task-item.done { opacity: 0.5; text-decoration: line-through; }
        .task-content { flex: 1; font-size: 0.95rem; cursor: pointer; }
        .task-desc { font-size: 0.8rem; color: #999; display: none; margin-top: 4px; border-top: 1px dashed #eee; padding-top: 4px; }
        .task-item.expanded .task-desc { display: block; }

        /* --- 5. MODALS & FAB --- */
        .fab {
            position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px;
            background: var(--primary); color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100; cursor: pointer;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .modal { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 16px; }
        .input-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }
        .type-select { display: flex; gap: 5px; margin-bottom: 15px; }
        .type-opt { flex: 1; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .type-opt.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-block { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; }

        /* Achievement Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #27ae60; color: white; padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 3000; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

    <canvas id="world"></canvas>

    <div class="app-layout">
        <div class="tower-view" onclick="this.classList.toggle('collapsed'); app.drawTower();"></div>
        
        <div class="main-sheet">
            
            <div class="profile-header">
                <div class="stats-box">
                    <div class="stats-title">ÁîüÊ∂ØÁ¥ØÁ©ç (LEGACY)</div>
                    <div class="stats-number" id="legacy-count">0</div>
                </div>
                <div class="badge-rack" id="badge-rack">
                    </div>
            </div>

            <div style="background:#fff; border-left:4px solid #3498db; padding:15px; border-radius:8px; margin-bottom:20px; cursor:pointer;" onclick="ui.modal('lore')">
                <div style="font-weight:bold; color:#2c3e50; margin-bottom:5px;">üìú ÂÜíÈö™ÊåáÂºï</div>
                <div id="lore-text" style="font-size:0.9rem; color:#666; white-space:pre-wrap;">Ë®≠ÂÆöÁõÆÊ®ô...</div>
            </div>

            <div class="grid-board">
                
                <div class="col-card">
                    <div class="col-header">
                        <span>ÁøíÊÖ£ Habits</span>
                        <i class="fas fa-trash" style="cursor:pointer" onclick="app.clear('habit')"></i>
                    </div>
                    <ul id="list-habit" class="task-list"></ul>
                </div>

                <div class="col-card">
                    <div class="col-header">
                        <span>ÊØèÊó• Daily</span>
                        <i class="fas fa-sync-alt" style="cursor:pointer" onclick="app.clear('daily')"></i>
                    </div>
                    <ul id="list-daily" class="task-list"></ul>
                </div>

                <div class="col-card">
                    <div class="col-header">
                        <span>ÂæÖËæ¶ Quest</span>
                        <i class="fas fa-archive" style="cursor:pointer" onclick="app.clear('todo')"></i>
                    </div>
                    <ul id="list-todo" class="task-list"></ul>
                </div>

            </div>

            <div style="text-align:center; margin-top:40px;">
                <button onclick="app.reset()" style="background:none; border:none; color:#ccc; text-decoration:underline; cursor:pointer;">ÈáçÁΩÆÊâÄÊúâË≥áÊñô</button>
            </div>
        </div>
    </div>

    <div class="fab" onclick="ui.modal('add')"><i class="fas fa-plus"></i></div>

    <div id="modal-add" class="modal-overlay">
        <div class="modal">
            <h3>Êñ∞Â¢ûÈ†ÖÁõÆ</h3>
            <input id="inp-title" class="input-box" placeholder="Ê®ôÈ°å">
            <textarea id="inp-desc" class="input-box" rows="3" placeholder="Ë©≥Á¥∞ÂÖßÂÆπ"></textarea>
            <div class="type-select">
                <div class="type-opt active" onclick="ui.setType('habit', this)">ÁøíÊÖ£</div>
                <div class="type-opt" onclick="ui.setType('daily', this)">ÊØèÊó•</div>
                <div class="type-opt" onclick="ui.setType('todo', this)">ÂæÖËæ¶</div>
            </div>
            <button class="btn-block" onclick="app.add()">Êñ∞Â¢û</button>
            <div style="text-align:center; margin-top:10px; color:#999; cursor:pointer;" onclick="document.getElementById('modal-add').style.display='none'">ÂèñÊ∂à</div>
        </div>
    </div>

    <div id="modal-lore" class="modal-overlay">
        <div class="modal">
            <h3>Á∑®ËºØË™ìË®Ä</h3>
            <textarea id="inp-lore" class="input-box" rows="6"></textarea>
            <button class="btn-block" onclick="app.saveLore()">‰øùÂ≠ò</button>
            <div style="text-align:center; margin-top:10px; color:#999; cursor:pointer;" onclick="document.getElementById('modal-lore').style.display='none'">ÂèñÊ∂à</div>
        </div>
    </div>

    <div id="toast" class="toast">
        <span style="font-size:1.5rem">üèÜ</span>
        <div>
            <div style="font-size:0.8rem; opacity:0.8">ÊàêÂ∞±Ëß£Èéñ</div>
            <div style="font-weight:bold" id="toast-msg">ÁØâÂ°îËÄÖ</div>
        </div>
    </div>

    <script>
        /* --- 1. VISUAL ENGINE (Optimized) --- */
        // Only draws when needed. No animation loop.
        const vis = {
            cvs: document.getElementById('world'),
            ctx: document.getElementById('world').getContext('2d'),
            
            init() {
                window.addEventListener('resize', () => this.draw());
                this.draw();
            },

            draw() {
                const w = this.cvs.width = window.innerWidth;
                const h = this.cvs.height = window.innerHeight * 0.5; // Top half
                const ctx = this.ctx;
                const count = store.db.legacy;

                // Simple gradient fill (No heavy calculation)
                // We rely on CSS for the main background to save JS overhead
                ctx.clearRect(0, 0, w, h);

                // Draw Tower
                const bw = 40; // Brick width
                const bh = 20; // Brick height
                const cols = Math.ceil(w / bw);
                const startY = h;

                let drawn = 0;
                let row = 0;

                ctx.fillStyle = '#95a5a6';
                ctx.strokeStyle = 'rgba(255,255,255,0.4)';

                while(drawn < count) {
                    let inRow = Math.min(cols, count - drawn);
                    // Center the row
                    let xOffset = (w - (inRow * bw)) / 2;
                    
                    for(let i = 0; i < inRow; i++) {
                        // Simple brick
                        let x = xOffset + i * bw;
                        let y = startY - (row * bh) - bh;
                        
                        // Vary color slightly for texture (static math, no random)
                        let hue = 200 + ((row + i) % 20);
                        ctx.fillStyle = `hsl(${hue}, 15%, 60%)`;
                        
                        ctx.fillRect(x, y, bw, bh);
                        ctx.strokeRect(x, y, bw, bh);
                    }
                    drawn += inRow;
                    row++;
                }
            }
        };

        /* --- 2. DATA STORE --- */
        const store = {
            db: JSON.parse(localStorage.getItem('lqe_v8')) || {
                tasks: [], legacy: 0, lore: "Âú®Ê≠§Ë®≠ÂÆö‰Ω†ÁöÑÊ†∏ÂøÉÁõÆÊ®ô...", lastLogin: Date.now()
            },
            save() { 
                localStorage.setItem('lqe_v8', JSON.stringify(this.db));
                app.render();
                vis.draw(); // Redraw tower only on save
                app.checkBadges();
            },
            checkReset() {
                const today = new Date().toDateString();
                const last = new Date(this.db.lastLogin).toDateString();
                if(today !== last) {
                    this.db.tasks.forEach(t => { if(t.type === 'daily') t.done = false; });
                    this.db.lastLogin = Date.now();
                    this.save();
                }
            }
        };

        /* --- 3. BADGE SYSTEM (New) --- */
        const badgeConfig = [
            { limit: 10, icon: 'üå±', title: 'ÂàùÂ≠∏ËÄÖ' },
            { limit: 50, icon: 'üî®', title: 'ÁØâÂ°îËÄÖ' },
            { limit: 100, icon: 'üè∞', title: 'Â†°Â£ò' },
            { limit: 500, icon: 'üëë', title: 'ÂúãÁéã' },
            { limit: 1000, icon: 'üåü', title: 'ÂÇ≥Â•á' }
        ];

        /* --- 4. APP LOGIC --- */
        let addType = 'habit';

        const app = {
            init() {
                store.checkReset();
                this.render();
                vis.init();
                this.checkBadges(true); // Init render badges
            },

            render() {
                // Stats
                document.getElementById('legacy-count').innerText = store.db.legacy;
                document.getElementById('lore-text').innerText = store.db.lore;
                document.getElementById('inp-lore').value = store.db.lore;

                // Lists
                const lists = { habit: '', daily: '', todo: '' };
                store.db.tasks.forEach(t => {
                    lists[t.type] += `
                        <li class="task-item type-${t.type} ${t.done ? 'done' : ''}" onclick="this.classList.toggle('expanded')">
                            <div class="check-box" onclick="event.stopPropagation(); app.check('${t.id}')"></div>
                            <div class="task-content">
                                <div>${t.title}</div>
                                <div class="task-desc">${t.desc || ''}</div>
                            </div>
                            <i class="fas fa-trash" style="color:#ddd; padding:5px;" onclick="event.stopPropagation(); app.del('${t.id}')"></i>
                        </li>`;
                });
                
                document.getElementById('list-habit').innerHTML = lists.habit;
                document.getElementById('list-daily').innerHTML = lists.daily;
                document.getElementById('list-todo').innerHTML = lists.todo;
            },

            checkBadges(silent = false) {
                const rack = document.getElementById('badge-rack');
                rack.innerHTML = '';
                const current = store.db.legacy;
                
                badgeConfig.forEach(b => {
                    const unlocked = current >= b.limit;
                    const el = document.createElement('div');
                    el.className = `badge ${unlocked ? 'unlocked' : ''}`;
                    el.innerText = b.icon;
                    el.title = `${b.title} (${b.limit})`;
                    rack.appendChild(el);

                    // Toast logic (Simple check: if just reached)
                    if(!silent && current === b.limit) ui.toast(b.title, b.icon);
                });
            },

            // Actions
            add() {
                const t = document.getElementById('inp-title').value;
                const d = document.getElementById('inp-desc').value;
                if(t) {
                    store.db.tasks.push({ id:Date.now().toString(36), type:addType, title:t, desc:d, done:false });
                    store.save();
                    document.getElementById('modal-add').style.display = 'none';
                    document.getElementById('inp-title').value = '';
                    document.getElementById('inp-desc').value = '';
                }
            },
            check(id) {
                const t = store.db.tasks.find(x => x.id === id);
                if(t) {
                    if(t.type === 'habit') { store.db.legacy++; }
                    else {
                        t.done = !t.done;
                        if(t.type === 'todo' && t.done) store.db.legacy++; // Todo adds legacy on done
                    }
                    store.save();
                }
            },
            del(id) {
                if(confirm('Âà™Èô§Ôºü')) {
                    store.db.tasks = store.db.tasks.filter(x => x.id !== id);
                    store.save();
                }
            },
            clear(type) {
                if(confirm(`Ê∏ÖÁ©∫ ${type}Ôºü`)) {
                    if(type === 'todo') {
                        // Harvest logic
                        const done = store.db.tasks.filter(t => t.type==='todo' && t.done);
                        store.db.legacy += done.length; // Ensure they are counted
                        store.db.tasks = store.db.tasks.filter(t => !(t.type==='todo' && t.done));
                    } else {
                        store.db.tasks = store.db.tasks.filter(t => t.type !== type);
                    }
                    store.save();
                }
            },
            saveLore() {
                store.db.lore = document.getElementById('inp-lore').value;
                store.save();
                document.getElementById('modal-lore').style.display = 'none';
            },
            reset() {
                if(confirm('Ë≠¶ÂëäÔºöÂà™Èô§ÊâÄÊúâË≥áÊñôÔºü')) { localStorage.removeItem('lqe_v8'); location.reload(); }
            }
        };

        /* --- 5. UI HELPERS --- */
        const ui = {
            modal(id) { document.getElementById('modal-'+id).style.display = 'flex'; },
            setType(type, el) {
                addType = type;
                document.querySelectorAll('.type-opt').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
            },
            toast(msg, icon) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.querySelector('span').innerText = icon;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        // Init
        app.init();

    </script>
</body>
</html>
