<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mind Sanctuary v7.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --primary: #2c3e50; --accent: #e67e22; --danger: #c0392b; --success: #27ae60;
            --habit: #f1c40f; --daily: #3498db; --todo: #e67e22;
            --bg-glass: rgba(255, 255, 255, 0.92);
            --nav-h: calc(65px + env(safe-area-inset-bottom, 20px));
            --radius: 16px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #dfe6e9; color: var(--primary); }

        /* --- 2. CANVAS LAYER --- */
        #world-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 45vh; z-index: 0; pointer-events: none; }

        /* --- 3. APP LAYOUT --- */
        .app-layout { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; z-index: 10; }
        .header-spacer { flex: 0 0 38vh; transition: flex 0.4s ease; cursor: pointer; }
        .header-spacer.collapsed { flex: 0 0 8vh; } /* é»æ“Šç¸®å°çœ‹å¡” */

        .main-sheet {
            flex: 1; background: var(--bg-glass); backdrop-filter: blur(12px);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            padding: 20px; padding-bottom: calc(var(--nav-h) + 20px);
            overflow-y: auto; scroll-behavior: smooth; transition: transform 0.3s;
        }

        /* --- 4. COMPONENTS --- */
        h2 { font-size: 0.9rem; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; display:flex; justify-content:space-between; align-items:center; }
        .btn { border: none; padding: 8px 16px; border-radius: 10px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: 0.1s; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(44,62,80,0.3); }
        .btn-ghost { background: transparent; color: #aaa; border: 1px solid #ddd; font-size: 0.8rem; padding: 4px 10px; }
        .btn-danger { background: #ffeaa7; color: #d63031; border: 1px solid #d63031; }
        
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: white; font-size: 1rem; margin-bottom: 10px; }

        /* --- 5. DASHBOARD GRID (v6.1 Layout) --- */
        .lore-card {
            background: #fff; border-left: 4px solid var(--daily); padding: 15px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer;
        }
        .lore-title { font-weight: bold; font-size: 0.95rem; margin-bottom: 5px; color: var(--primary); display:flex; justify-content:space-between; }
        .lore-desc { font-size: 0.9rem; color: #7f8c8d; line-height: 1.5; white-space: pre-wrap; }

        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;
        }
        .col-card { background: rgba(255,255,255,0.6); padding: 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .col-header { font-size: 0.85rem; font-weight: bold; color: #7f8c8d; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }

        /* Task Items */
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            background: white; padding: 12px; margin-bottom: 8px; border-radius: 10px;
            display: flex; align-items: center; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        /* Color Coding */
        .type-habit { border-left-color: var(--habit); }
        .type-daily { border-left-color: var(--daily); }
        .type-todo { border-left-color: var(--todo); }

        .task-check { 
            width: 22px; height: 22px; border-radius: 6px; margin-right: 10px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0; background: #eee;
        }
        .type-habit .task-check { background: var(--habit); color: white; font-weight: bold; }
        .type-habit .task-check::after { content: '+'; }
        
        .task-content { flex: 1; }
        .task-title { font-size: 0.95rem; font-weight: 600; }
        .task-desc { font-size: 0.8rem; color: #999; margin-top: 2px; }
        
        .task-item.done { opacity: 0.6; background: #f8f9fa; }
        .task-item.done .task-title { text-decoration: line-through; }
        .type-todo.done .task-check { background: var(--todo); color: white; }
        .type-todo.done .task-check::after { content: 'âœ”'; }
        .type-daily.done .task-check { background: #bdc3c7; }

        /* --- 6. OTHER TABS (Gacha, Void, Journal) --- */
        .tab-content { display: none; animation: slideUp 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .void-box { background: #2d3436; color: #dfe6e9; padding: 25px; border-radius: 16px; text-align: center; }
        .focus-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44,62,80,0.98); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        
        /* --- 7. NAV & MODALS --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding-top: 12px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item { text-align: center; color: #bdc3c7; font-size: 0.7rem; cursor: pointer; transition: 0.2s; width: 50px; }
        .nav-item i { display: block; font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }

        .fab {
            position: fixed; bottom: calc(var(--nav-h) + 20px); right: 20px;
            width: 56px; height: 56px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; box-shadow: 0 5px 15px rgba(44,62,80,0.4); z-index: 100; cursor: pointer; transition: transform 0.2s;
        }
        .fab:active { transform: rotate(90deg); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; animation: popUp 0.3s; }
        .radio-group { display: flex; gap: 5px; margin-bottom: 15px; }
        .radio-opt { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 0.85rem; cursor: pointer; }
        .radio-opt.selected { background: var(--primary); color: white; border-color: var(--primary); }

        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="world-canvas"></canvas>

    <div class="app-layout">
        <div class="header-spacer" id="header-spacer" onclick="app.toggleView()"></div>
        
        <div class="main-sheet">
            
            <div id="tab-home" class="tab-content active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div>
                        <h1 style="margin:0; font-size:1.4rem;">å¿ƒéˆè–æ®¿</h1>
                        <span style="font-size:0.8rem; color:#aaa;">Lv.<span id="stat-lvl">1</span> | ç”Ÿæ¶¯ç´¯ç©: <span id="stat-legacy">0</span></span>
                    </div>
                    <button class="btn-ghost" onclick="app.toggleView()" style="border:none;"><i class="fas fa-expand-alt"></i> çœ‹å¡”</button>
                </div>

                <div class="lore-card" onclick="ui.modalOpen('lore')">
                    <div class="lore-title">
                        <span><i class="fas fa-scroll"></i> å†’éšªæŒ‡å¼•</span>
                        <i class="fas fa-pen" style="opacity:0.5; font-size:0.8rem;"></i>
                    </div>
                    <div class="lore-desc" id="display-lore">é»æ“Šè¨­å®šä½ çš„ç›®æ¨™...</div>
                </div>

                <div class="dashboard-grid">
                    
                    <div class="col-card">
                        <div class="col-header">
                            <span style="color:var(--habit)"><i class="fas fa-redo"></i> ç¿’æ…£</span>
                            <i class="fas fa-trash btn-ghost" onclick="app.clearList('habit')" title="æ¸…ç©ºç¿’æ…£"></i>
                        </div>
                        <ul id="list-habit" class="task-list"></ul>
                    </div>

                    <div class="col-card">
                        <div class="col-header">
                            <span style="color:var(--daily)"><i class="fas fa-sun"></i> æ¯æ—¥å„€å¼</span>
                            <i class="fas fa-trash btn-ghost" onclick="app.clearList('daily')" title="é‡ç½®ä»Šæ—¥"></i>
                        </div>
                        <ul id="list-daily" class="task-list"></ul>
                    </div>

                    <div class="col-card">
                        <div class="col-header">
                            <span style="color:var(--todo)"><i class="fas fa-check-square"></i> å¾…è¾¦è¡Œå‹•</span>
                            <i class="fas fa-archive btn-ghost" onclick="app.clearList('todo')" title="å°å­˜å®Œæˆé …ç›®"></i>
                        </div>
                        <ul id="list-todo" class="task-list"></ul>
                    </div>

                </div>
            </div>

            <div id="tab-gacha" class="tab-content">
                <div style="text-align:center; padding:30px 0;">
                    <i class="fas fa-dice-d20" style="font-size:4rem; color:var(--primary); margin-bottom:20px;"></i><br>
                    <button class="btn btn-primary" onclick="app.spinGacha()">å‘½é‹æŒ‡å¼•</button>
                    <div id="gacha-result" style="display:none; margin-top:20px; border:2px solid var(--accent); padding:15px; border-radius:12px; text-align:left;">
                        <h3 id="res-title" style="margin:0; color:var(--primary)"></h3>
                        <p id="res-desc" style="color:#666; margin:5px 0 15px 0;"></p>
                        <button class="btn btn-primary" style="width:100%" onclick="app.acceptGacha()">æ¥å—æŒ‘æˆ°</button>
                    </div>
                </div>
                <h2>æŒ‘æˆ°æ±  <button class="btn-ghost" onclick="app.clearList('pool')">æ¸…ç©º</button></h2>
                <div style="display:flex; gap:10px;">
                    <input id="pool-in" class="input-box" placeholder="æ–°æŒ‘æˆ°..." style="margin:0">
                    <button class="btn btn-primary" style="padding:10px 15px;" onclick="app.addPool()">+</button>
                </div>
                <ul id="list-pool" class="task-list" style="margin-top:10px;"></ul>
            </div>

            <div id="tab-void" class="tab-content">
                <h2>æƒ…ç·’ç¢ç´™æ©Ÿ</h2>
                <div class="void-box">
                    <p style="opacity:0.7; margin-top:0; font-size:0.9rem;">å¯«ä¸‹ç„¦æ…®ï¼Œç„¶å¾Œæ¯€æ»…å®ƒã€‚</p>
                    <textarea id="void-input" class="input-box" rows="4" style="background:rgba(255,255,255,0.1); color:white; border:none;"></textarea>
                    <button class="btn btn-danger" style="width:100%; border:none; color:white;" onclick="app.shred()">æ¯€æ»…å¿µé ­</button>
                </div>
                <h2>å°ˆæ³¨çµç•Œ</h2>
                <div style="background:white; padding:20px; border-radius:12px; text-align:center;">
                    <i class="fas fa-stopwatch" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                    <p style="font-size:0.9rem; color:#666;">25 åˆ†é˜çµ•å°å°ˆæ³¨ã€‚</p>
                    <button class="btn btn-primary" style="width:100%;" onclick="app.startFocus()">é–‹å•Ÿçµç•Œ</button>
                </div>
            </div>

            <div id="tab-journal" class="tab-content">
                <h2>æ¯æ—¥æª¢è¨ <button class="btn-ghost" onclick="app.clearList('journal')">æ¸…ç©º</button></h2>
                <div style="background:white; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:1.5rem; margin-bottom:10px;">
                        <span onclick="app.setMood('ğŸ˜­')" style="cursor:pointer; opacity:0.5;">ğŸ˜­</span>
                        <span onclick="app.setMood('ğŸ˜')" style="cursor:pointer; opacity:0.5;">ğŸ˜</span>
                        <span onclick="app.setMood('ğŸ™‚')" style="cursor:pointer; opacity:0.5;">ğŸ™‚</span>
                        <span onclick="app.setMood('ğŸ¤©')" style="cursor:pointer; opacity:0.5;">ğŸ¤©</span>
                    </div>
                    <textarea id="j-note" class="input-box" rows="3" placeholder="ä»Šæ—¥å¿ƒå¾—..."></textarea>
                    <button class="btn btn-primary" style="width:100%" onclick="app.saveJournal()">è¨˜éŒ„</button>
                </div>
                <ul id="list-journal" class="task-list"></ul>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2>ç”Ÿæ¶¯ç´¯ç© (æ­·å²) <button class="btn-ghost" onclick="app.clearList('legacy')">æ¸…ç©º</button></h2>
                <p style="font-size:0.8rem; color:#888;">é€™è£¡ç´€éŒ„è‘—æ‰€æœ‰ä½ å°å­˜çš„æˆå°±ã€‚</p>
                
                <h2 style="margin-top:30px;">è³‡æ–™ç®¡ç†</h2>
                <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="app.exportData()">å‚™ä»½è³‡æ–™ (JSON)</button>
                <button class="btn btn-danger" style="width:100%" onclick="app.resetAll()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            </div>

        </div>
    </div>

    <div class="fab" onclick="ui.modalOpen('task')"><i class="fas fa-plus"></i></div>

    <div id="modal-task" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0;">æ–°å¢é …ç›®</h3>
            <input id="inp-title" class="input-box" placeholder="æ¨™é¡Œ">
            <input id="inp-desc" class="input-box" placeholder="è©³ç´°èªªæ˜ (é¸å¡«)">
            <div class="radio-group">
                <div class="radio-opt selected" onclick="app.setType('habit', this)" style="border-color:var(--habit); color:var(--habit)">ç¿’æ…£</div>
                <div class="radio-opt" onclick="app.setType('daily', this)" style="border-color:var(--daily); color:var(--daily)">å„€å¼</div>
                <div class="radio-opt" onclick="app.setType('todo', this)" style="border-color:var(--todo); color:var(--todo)">è¡Œå‹•</div>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="app.addTask()">æ–°å¢</button>
            <div style="text-align:center; margin-top:15px; font-size:0.8rem; color:#999; cursor:pointer;" onclick="ui.modalClose('task')">å–æ¶ˆ</div>
        </div>
    </div>

    <div id="modal-lore" class="modal-overlay">
        <div class="modal">
            <h3>ç·¨è¼¯å†’éšªæŒ‡å¼•</h3>
            <textarea id="inp-lore" class="input-box" rows="5"></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="app.saveLore()">ä¿å­˜</button>
            <div style="text-align:center; margin-top:15px; font-size:0.8rem; color:#999; cursor:pointer;" onclick="ui.modalClose('lore')">å–æ¶ˆ</div>
        </div>
    </div>

    <div id="focus-overlay" class="focus-overlay">
        <div style="font-size:4rem; font-weight:100;" id="focus-timer">25:00</div>
        <button class="btn btn-ghost" style="color:white; border-color:white; margin-top:20px;" onclick="app.stopFocus()">æ”¾æ£„</button>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="ui.tab('home', this)"><i class="fas fa-dungeon"></i>è–æ®¿</div>
        <div class="nav-item" onclick="ui.tab('gacha', this)"><i class="fas fa-dice"></i>å‘½é‹</div>
        <div class="nav-item" onclick="ui.tab('void', this)"><i class="fas fa-ghost"></i>æ·¨åŒ–</div>
        <div class="nav-item" onclick="ui.tab('journal', this)"><i class="fas fa-book-open"></i>æ—¥èªŒ</div>
        <div class="nav-item" onclick="ui.tab('settings', this)"><i class="fas fa-cog"></i>è¨­å®š</div>
    </nav>

    <script>
        /* --- 1. Sound (8-bit) --- */
        const sfx = {
            ctx: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
            beep(f,t,d) {
                if(!this.ctx) this.init(); if(this.ctx.state==='suspended') this.ctx.resume();
                const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.type=t; o.frequency.value=f; g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+d);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d);
            },
            click() { this.beep(800,'sine',0.05); },
            win() { [440,554,659].forEach((f,i)=>setTimeout(()=>this.beep(f,'square',0.1),i*80)); },
            trash() { this.beep(150,'sawtooth',0.2); }
        };

        /* --- 2. Visuals (Canvas Tower) --- */
        const vis = {
            cvs: document.getElementById('world-canvas'),
            ctx: document.getElementById('world-canvas').getContext('2d'),
            resize() { this.cvs.width=window.innerWidth; this.cvs.height=window.innerHeight*0.5; this.draw(); },
            draw() {
                const w=this.cvs.width, h=this.cvs.height, ctx=this.ctx, count=store.db.legacy;
                // Sky
                const hr=new Date().getHours(), isNight=hr<6||hr>=18;
                const grad=ctx.createLinearGradient(0,0,0,h);
                grad.addColorStop(0, isNight?'#0f2027':'#89f7fe'); 
                grad.addColorStop(1, isNight?'#2c3e50':'#66a6ff');
                ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
                // Tower
                const bw=30, bh=15, cols=Math.ceil(w/bw), startY=h;
                let drawn=0, row=0;
                ctx.fillStyle='#95a5a6'; ctx.strokeStyle='rgba(255,255,255,0.3)';
                while(drawn<count){
                    let inRow=Math.min(cols, count-drawn);
                    for(let i=0; i<inRow; i++){
                        ctx.fillRect((w-(inRow*bw))/2+i*bw, startY-(row*bh)-bh, bw, bh);
                        ctx.strokeRect((w-(inRow*bw))/2+i*bw, startY-(row*bh)-bh, bw, bh);
                    }
                    drawn+=inRow; row++;
                }
            }
        };
        window.onresize=()=>vis.resize();

        /* --- 3. Data Store --- */
        const store = {
            db: JSON.parse(localStorage.getItem('ms_v7')) || {
                tasks: [], legacy: 0, journals: [], 
                pool: [{t:"æ·±å‘¼å¸",d:"3æ¬¡"},{t:"å–æ°´",d:"500cc"}],
                lore: "æ­¡è¿ä¾†åˆ°å…¬æœƒå¤§å»³ã€‚\né»æ“Šé€™è£¡è¨­å®šä½ çš„å†’éšªç›®æ¨™...",
                lastLogin: Date.now()
            },
            save() { localStorage.setItem('ms_v7', JSON.stringify(this.db)); vis.draw(); },
            checkReset() {
                const today = new Date().toDateString();
                const last = new Date(this.db.lastLogin).toDateString();
                if(today !== last) {
                    this.db.tasks.forEach(t=>{ if(t.type==='daily') t.done=false; });
                    this.db.lastLogin = Date.now();
                    this.save();
                    alert('â˜€ï¸ æ–°çš„ä¸€å¤©ï¼šæ¯æ—¥å„€å¼å·²é‡ç½®ï¼');
                }
            }
        };

        /* --- 4. App Logic --- */
        let addType = 'habit';
        let currentMood = '';

        const app = {
            init() {
                // Default data if empty
                if(store.db.tasks.length===0) {
                    store.db.tasks=[
                        {id:1, type:'habit', title:'å–æ°´', desc:'ä¿æŒæ°´åˆ†', done:false, count:0},
                        {id:2, type:'daily', title:'æ¯æ—¥é‹å‹•', desc:'30åˆ†é˜', done:false},
                        {id:3, type:'todo', title:'è¨­å®šAPP', desc:'ç†Ÿæ‚‰æ“ä½œ', done:false}
                    ];
                    store.save();
                }
                store.checkReset();
                this.render();
                vis.resize();
            },
            
            render() {
                // Stats & Lore
                document.getElementById('stat-legacy').innerText = store.db.legacy;
                document.getElementById('stat-lvl').innerText = Math.floor(Math.sqrt(store.db.legacy)) + 1;
                document.getElementById('display-lore').innerText = store.db.lore;
                document.getElementById('inp-lore').value = store.db.lore;

                // Lists
                const habitUl=document.getElementById('list-habit');
                const dailyUl=document.getElementById('list-daily');
                const todoUl=document.getElementById('list-todo');
                habitUl.innerHTML=''; dailyUl.innerHTML=''; todoUl.innerHTML='';

                store.db.tasks.forEach(t => {
                    const li = document.createElement('li');
                    li.className = `task-item type-${t.type} ${t.done?'done':''}`;
                    li.innerHTML = `
                        <div class="task-check" onclick="app.check('${t.id}')"></div>
                        <div class="task-content">
                            <div class="task-title">${t.title}</div>
                            ${t.desc?`<div class="task-desc">${t.desc}</div>`:''}
                            ${t.count?`<div class="task-desc">æ¬¡æ•¸: ${t.count}</div>`:''}
                        </div>
                        <i class="fas fa-trash" style="color:#ddd; padding:5px; cursor:pointer;" onclick="app.del('${t.id}')"></i>
                    `;
                    if(t.type==='habit') habitUl.appendChild(li);
                    else if(t.type==='daily') dailyUl.appendChild(li);
                    else if(!t.done) todoUl.appendChild(li); // Only show active todos
                });

                // Render other lists
                ui.renderList('list-pool', store.db.pool, i=>`<b>${i.t}</b> <small>${i.d}</small>`);
                ui.renderList('list-journal', store.db.journals, i=>`<small>${i.date} ${i.mood||''}</small><br>${i.text}`);
            },

            // Task Ops
            setType(t, el) { addType=t; document.querySelectorAll('.radio-opt').forEach(e=>e.classList.remove('selected')); el.classList.add('selected'); },
            addTask() {
                const t=document.getElementById('inp-title').value, d=document.getElementById('inp-desc').value;
                if(t) {
                    store.db.tasks.push({id:Date.now().toString(36), type:addType, title:t, desc:d, done:false, count:0});
                    store.save(); this.render(); ui.modalClose('task');
                    document.getElementById('inp-title').value=''; document.getElementById('inp-desc').value='';
                    sfx.click();
                }
            },
            check(id) {
                const t = store.db.tasks.find(x=>x.id==id);
                if(t) {
                    if(t.type==='habit') { t.count++; store.db.legacy++; sfx.win(); }
                    else { t.done=!t.done; sfx.click(); }
                    store.save(); this.render();
                }
            },
            del(id) {
                if(confirm('ç§»é™¤æ­¤é …ç›®ï¼Ÿ')) {
                    store.db.tasks = store.db.tasks.filter(x=>x.id!=id);
                    store.save(); this.render(); sfx.trash();
                }
            },
            
            // Clear Ops (Granular)
            clearList(type) {
                if(!confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) return;
                sfx.trash();
                if(type==='habit') store.db.tasks = store.db.tasks.filter(t=>t.type!=='habit');
                else if(type==='daily') store.db.tasks = store.db.tasks.filter(t=>t.type!=='daily');
                else if(type==='todo') { // Harvest logic for todo
                    const done = store.db.tasks.filter(t=>t.type==='todo' && t.done);
                    store.db.legacy += done.length;
                    store.db.tasks = store.db.tasks.filter(t=>t.type!=='todo' || !t.done);
                    sfx.win();
                }
                else if(type==='pool') store.db.pool = [];
                else if(type==='journal') store.db.journals = [];
                else if(type==='legacy') store.db.legacy = 0;
                store.save(); this.render();
            },
            resetAll() { if(confirm('âš ï¸ åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.removeItem('ms_v7'); location.reload(); } },

            // Other Features
            saveLore() { store.db.lore = document.getElementById('inp-lore').value; store.save(); this.render(); ui.modalClose('lore'); },
            addPool() { const v=document.getElementById('pool-in').value; if(v){ store.db.pool.push({t:v,d:''}); store.save(); this.render(); document.getElementById('pool-in').value=''; } },
            spinGacha() { 
                if(!store.db.pool.length) return alert('æ± æ˜¯ç©ºçš„');
                const i = store.db.pool[Math.floor(Math.random()*store.db.pool.length)];
                this.tempGacha = i;
                document.getElementById('res-title').innerText = i.t;
                document.getElementById('res-desc').innerText = i.d;
                document.getElementById('gacha-result').style.display='block';
                sfx.win();
            },
            acceptGacha() {
                if(this.tempGacha) {
                    store.db.tasks.push({id:Date.now().toString(36), type:'todo', title:this.tempGacha.t, desc:'å‘½é‹æŒ‘æˆ°', done:false});
                    store.save(); this.render();
                    document.getElementById('gacha-result').style.display='none';
                    ui.tab('home', document.querySelectorAll('.nav-item')[0]);
                }
            },
            shred() {
                const el = document.getElementById('void-input');
                if(el.value) { sfx.trash(); el.style.transition='0.5s'; el.style.transform='scale(0)'; setTimeout(()=>{el.value='';el.style.transform='none';},500); }
            },
            startFocus() {
                document.getElementById('focus-overlay').style.display='flex';
                let s = 25*60;
                this.timer = setInterval(()=>{
                    s--; document.getElementById('focus-timer').innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                    if(s<=0) { clearInterval(this.timer); sfx.win(); alert('å®Œæˆï¼'); this.stopFocus(); }
                }, 1000);
            },
            stopFocus() { clearInterval(this.timer); document.getElementById('focus-overlay').style.display='none'; },
            setMood(m) { currentMood=m; sfx.click(); },
            saveJournal() {
                const t=document.getElementById('j-note').value;
                if(t||currentMood) { store.db.journals.unshift({date:new Date().toLocaleString(), mood:currentMood, text:t}); store.save(); this.render(); document.getElementById('j-note').value=''; sfx.win(); }
            },
            exportData() {
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(store.db));
                a.download = "sanctuary_data.json"; a.click();
            },
            toggleView() { document.querySelector('.header-spacer').classList.toggle('collapsed'); }
        };

        /* --- 5. UI Helpers --- */
        const ui = {
            tab(id, el) {
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
                document.getElementById('tab-'+id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                el.classList.add('active');
                document.querySelector('.fab').style.display = id==='home'?'flex':'none';
                sfx.click();
            },
            modalOpen(id) { document.getElementById('modal-'+id).style.display='flex'; },
            modalClose(id) { document.getElementById('modal-'+id).style.display='none'; },
            renderList(id, list, htmlFn) {
                const ul = document.getElementById(id); ul.innerHTML='';
                list.forEach((item, i) => {
                    ul.innerHTML += `<li class="task-item"><div class="task-content">${htmlFn(item)}</div></li>`;
                });
            }
        };

        // Init
        app.init();
    </script>
</body>
</html>
