<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Life Quest v3.6</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d35400; 
            --bg: #fdfbf7;
            --stone: #95a5a6;
            --stone-dark: #7f8c8d;
            --nav-height: calc(60px + env(safe-area-inset-bottom, 0px));
            --success: #27ae60;
            --danger: #c0392b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: #333;
            margin: 0; padding: 0;
            padding-bottom: calc(var(--nav-height) + 20px); 
            overscroll-behavior-y: none;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* --- Header: Legacy & Cooldown --- */
        header {
            background: white; padding: 15px 20px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .legacy-box { text-align: left; }
        .legacy-label { font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        .legacy-count { font-size: 1.8rem; font-weight: 800; color: var(--primary); line-height: 1.2; }
        
        .cooldown-btn {
            width: 40px; height: 40px; border-radius: 50%; background: #ffebee; color: var(--danger);
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: transform 0.2s;
        }
        .cooldown-btn:active { transform: scale(0.9); }

        /* --- Tab Content --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Task Lists (Active & Sediment) --- */
        .section-title { font-size: 0.9rem; color: #aaa; font-weight: bold; margin: 15px 0 10px 0; }
        .task-list { list-style: none; padding: 0; margin: 0; }
        
        .task-item {
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; align-items: flex-start; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative;
        }
        .check-circle {
            width: 24px; height: 24px; border: 2px solid var(--accent); border-radius: 50%;
            margin-right: 12px; cursor: pointer; flex-shrink: 0; margin-top: 2px;
        }
        
        .task-content { flex-grow: 1; min-width: 0; }
        .task-title { font-size: 1rem; font-weight: 500; color: #333; margin-bottom: 2px; }
        .task-desc { font-size: 0.85rem; color: #888; white-space: pre-wrap; display: none; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #eee;}
        .task-item.expanded .task-desc { display: block; }
        
        .expand-btn { color: #ccc; padding: 5px; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }

        /* Sediment (Completed) */
        .task-item.sediment {
            background: #ecf0f1; border-left: 5px solid var(--stone); border-radius: 6px; 
            margin-bottom: 4px; padding: 10px 15px; color: var(--stone-dark); transform: scale(0.98); box-shadow: none;
        }
        .task-item.sediment .check-circle { border-color: var(--stone); background: var(--stone); width: 12px; height: 12px; margin-right: 15px; pointer-events: none; }
        .task-item.sediment .task-title { text-decoration: line-through; font-size: 0.9rem; color: #7f8c8d; }
        .task-item.sediment .task-desc { display: none !important; }

        /* Harvest Button */
        .harvest-container { text-align: center; margin: 20px 0; display: none; }
        .harvest-btn {
            background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 30px;
            font-size: 0.9rem; cursor: pointer; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.3);
            display: inline-flex; align-items: center; gap: 8px;
        }

        /* --- Floating Action Button (Add Task) --- */
        .fab {
            position: fixed; bottom: 90px; right: 20px;
            width: 56px; height: 56px; background: var(--accent); border-radius: 50%;
            color: white; display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(211, 84, 0, 0.4); cursor: pointer; z-index: 100;
        }

        /* --- Gacha Styles --- */
        .gacha-container { text-align: center; padding: 30px 10px; }
        .gacha-machine { font-size: 5rem; color: var(--primary); margin-bottom: 20px; }
        .gacha-result-card { background: white; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); display: none; margin-top: 20px; text-align: left;}
        .pool-list { list-style: none; padding: 0; text-align: left; margin-top: 10px; }
        .pool-item { background: white; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }

        /* --- Journal Styles --- */
        .journal-form { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .mood-selector { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .mood-btn { font-size: 1.5rem; background: none; border: 2px solid transparent; border-radius: 50%; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .mood-btn.selected { opacity: 1; transform: scale(1.2); border-color: #eee; background: #fffdf0; }
        
        .review-question { margin-bottom: 15px; }
        .review-label { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 5px; display: block; }
        .review-input { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9; }
        
        .journal-history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #eee; }

        /* --- Settings Styles --- */
        .settings-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: flex-start;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; padding-top: 10px;
        }
        .nav-item { flex: 1; text-align: center; color: #ccc; cursor: pointer; font-size: 0.75rem; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; position: relative; }
        .modal h3 { margin-top: 0; color: var(--primary); }
        .modal-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; }
        .modal-textarea { height: 100px; resize: none; }
        .modal-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .close-modal { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; color: #999; }

        /* Cooldown specific */
        .cooldown-timer { font-size: 3rem; font-weight: bold; text-align: center; margin: 20px 0; }
        
        /* Animation */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="legacy-box">
                <div class="legacy-label">ÁîüÊ∂ØÁ¥ØÁ©ç (Legacy)</div>
                <div class="legacy-count" id="total-count">0</div>
            </div>
            <button class="cooldown-btn" onclick="openCooldown()" title="ÂÜ∑ÈùúÊ®°Âºè">
                <i class="fas fa-fire"></i>
            </button>
        </header>

        <div id="tab-home" class="tab-content active">
            <div class="section-title">‰ªäÊó•‰ªªÂãô (Active)</div>
            <ul id="active-list" class="task-list"></ul>
            
            <div class="harvest-container" id="harvest-area">
                <button class="harvest-btn" onclick="harvestTasks()">
                    <i class="fas fa-archive"></i> Â∞ÅÂ≠ò‰∏¶Á¥ØÁ©çÈªûÊï∏
                </button>
            </div>

            <div class="section-title">Â∑≤ÂÆåÊàêÂ†ÜÁñä (Sediment)</div>
            <ul id="sediment-list" class="task-list"></ul>
            
            <div class="fab" onclick="openTaskModal()"><i class="fas fa-plus"></i></div>
        </div>

        <div id="tab-gacha" class="tab-content">
            <div class="gacha-container">
                <div id="gacha-icon" class="gacha-machine"><i class="fas fa-dice-d20"></i></div>
                <button onclick="playGacha()" class="harvest-btn" style="background:var(--accent)">ÂëΩÈÅãÊäΩÁ±§</button>
                
                <div id="gacha-result" class="gacha-result-card">
                    <h3 id="gacha-title" style="margin-top:0; color:var(--primary)"></h3>
                    <p id="gacha-desc" style="color:#666"></p>
                    <button onclick="acceptGacha()" class="modal-btn" style="background:var(--accent)">Êé•ÂèóÊåëÊà∞</button>
                </div>
            </div>
            <div class="section-title" style="padding:0 10px;">ÊäΩÁ±§Ê±†Ë®≠ÂÆö</div>
            <div style="padding: 10px; background: white; border-radius: 12px; margin: 0 10px;">
                <input id="pool-new-title" placeholder="ÊåëÊà∞Ê®ôÈ°å" class="modal-input" style="margin-bottom:5px;">
                <input id="pool-new-desc" placeholder="ÊåëÊà∞ÊèèËø∞" class="modal-input">
                <button onclick="addToPool()" class="modal-btn" style="padding:8px; font-size:0.9rem;">Âä†ÂÖ•Ê±†‰∏≠</button>
            </div>
            <ul id="pool-list" class="pool-list" style="margin: 10px;"></ul>
        </div>

        <div id="tab-journal" class="tab-content">
            <div class="journal-form">
                <h3>ÊØèÊó•Ê™¢Ë®é</h3>
                <div class="mood-selector">
                    <button class="mood-btn" onclick="selectMood('ü§©')">ü§©</button>
                    <button class="mood-btn" onclick="selectMood('üôÇ')">üôÇ</button>
                    <button class="mood-btn" onclick="selectMood('üòê')">üòê</button>
                    <button class="mood-btn" onclick="selectMood('üò´')">üò´</button>
                    <button class="mood-btn" onclick="selectMood('üò°')">üò°</button>
                </div>
                
                <div id="dynamic-questions-area">
                    </div>

                <div class="review-question">
                    <span class="review-label">Ëá™Áî±Á≠ÜË®ò</span>
                    <textarea id="journal-free-text" class="modal-input modal-textarea" placeholder="ÂÖ∂‰ªñÊÉ≥Ë™™ÁöÑ..."></textarea>
                </div>
                <button onclick="saveJournal()" class="modal-btn">Ë®òÈåÑ‰ªäÂ§©</button>
            </div>
            
            <div class="section-title">Ê≠∑Âè≤Êó•Ë™å</div>
            <ul id="journal-history" style="list-style:none; padding:0;"></ul>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="section-title">Ë®≠ÂÆöÊ™¢Ë®éÂïèÈ°å</div>
            <div style="background: white; padding: 15px; border-radius: 12px;">
                <p style="font-size:0.8rem; color:#888; margin-top:0;">Êñ∞Â¢ûÂïèÈ°åÂ∞áÈ°ØÁ§∫Âú®„ÄåÊó•Ë™å„ÄçÈ†ÅÈù¢‰∏≠„ÄÇ</p>
                <div style="display:flex; gap:10px;">
                    <input id="new-question-input" class="modal-input" placeholder="‰æãÂ¶ÇÔºö‰ªäÂ§©ÊúâÈÅãÂãïÂóéÔºü" style="margin-bottom:0;">
                    <button onclick="addQuestionTemplate()" class="modal-btn" style="width:auto;">Êñ∞Â¢û</button>
                </div>
            </div>
            <ul id="questions-list" style="list-style:none; padding:0; margin-top:10px;"></ul>
            
            <div class="section-title" style="margin-top:30px;">Ë≥áÊñôÁÆ°ÁêÜ</div>
            <button onclick="resetAllData()" class="modal-btn" style="background:var(--stone); margin-bottom:10px;">ÈáçÁΩÆÊâÄÊúâË≥áÊñô</button>
        </div>

    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-tasks"></i>‰ªªÂãô</div>
        <div class="nav-item" onclick="switchTab('gacha')"><i class="fas fa-dice"></i>ÊäΩÁ±§</div>
        <div class="nav-item" onclick="switchTab('journal')"><i class="fas fa-book"></i>Êó•Ë™å</div>
        <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i>Ë®≠ÂÆö</div>
    </nav>

    <div id="task-modal" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="closeTaskModal()">&times;</span>
            <h3>Êñ∞Â¢û‰ªªÂãô</h3>
            <input type="text" id="modal-task-title" class="modal-input" placeholder="Ê®ôÈ°å (ÂøÖÂ°´)">
            <textarea id="modal-task-desc" class="modal-input modal-textarea" placeholder="Ë©≥Á¥∞ÂÖßÂÆπ (ÈÅ∏Â°´)"></textarea>
            <button onclick="saveTaskFromModal()" class="modal-btn">Êñ∞Â¢û</button>
        </div>
    </div>

    <div id="cooldown-modal" class="modal-overlay">
        <div class="modal" style="text-align:center;">
            <h3>üî• ÂÜ∑ÈùúÊ®°Âºè</h3>
            <div class="cooldown-timer" id="timer-display">03:00</div>
            <textarea class="modal-input modal-textarea" placeholder="Âú®ÈÄôË£°ÂÆ£Ê¥©ÊÉÖÁ∑í (‰∏çÊúÉÂÑ≤Â≠ò)..." id="anger-input"></textarea>
            <button id="stop-cooldown-btn" class="modal-btn" style="background:#ccc" disabled onclick="stopCooldown()">Ë®àÊôÇ‰∏≠...</button>
            <div style="margin-top:10px; font-size:0.8rem; color:#888; cursor:pointer; text-decoration:underline;" onclick="closeCooldown()">ÊîæÊ£Ñ‰∏¶ÈóúÈñâ</div>
        </div>
    </div>

    <script>
        /* --- Data Management --- */
        let tasks = JSON.parse(localStorage.getItem('v36_tasks')) || [];
        let legacyCount = parseInt(localStorage.getItem('v36_legacy_count')) || 0;
        let journals = JSON.parse(localStorage.getItem('v36_journals')) || [];
        
        // Default Gacha Pool
        let gachaPool = JSON.parse(localStorage.getItem('v36_pool')) || [
            {title: "Êï¥ÁêÜÁí∞Â¢É", desc: "Êï¥ÁêÜÊ°åÈù¢ÊàñÊàøÈñìÁöÑ‰∏ÄËßí"},
            {title: "ÂñùÊ∞¥", desc: "Âñù‰∏ÄÊùØÊ∫´ÈñãÊ∞¥"},
            {title: "Êñ∑Á∂≤", desc: "ÊâãÊ©üÈñãÈ£õËà™Ê®°Âºè 30 ÂàÜÈêò"}
        ];

        // Review Questions Templates
        let reviewQuestions = JSON.parse(localStorage.getItem('v36_questions')) || [
            "‰ªäÂ§©ÊúÄÊ£íÁöÑ‰∏Ä‰ª∂‰∫ãÊòØ‰ªÄÈ∫ºÔºü",
            "Êúâ‰ªÄÈ∫ºÂèØ‰ª•ÊîπÈÄ≤ÁöÑÂú∞ÊñπÔºü"
        ];

        let currentMood = '';

        /* --- Init --- */
        document.addEventListener('DOMContentLoaded', () => {
            updateLegacyDisplay();
            renderTasks();
            renderPool();
            renderQuestionSettings();
            renderJournalQuestions();
            renderJournalHistory();
        });

        /* --- Tab Logic --- */
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            const idx = ['home', 'gacha', 'journal', 'settings'].indexOf(tabName);
            document.querySelectorAll('.nav-item')[idx].classList.add('active');
        }

        /* --- Task Logic --- */
        function renderTasks() {
            const activeList = document.getElementById('active-list');
            const sedimentList = document.getElementById('sediment-list');
            const harvestArea = document.getElementById('harvest-area');
            
            activeList.innerHTML = ''; sedimentList.innerHTML = '';
            let hasCompleted = false;

            // Sort by time
            tasks.sort((a, b) => b.timestamp - a.timestamp);

            tasks.forEach(task => {
                const li = document.createElement('li');
                
                if (!task.completed) {
                    li.className = 'task-item';
                    li.innerHTML = `
                        <div class="check-circle" onclick="toggleTask('${task.id}')"></div>
                        <div class="task-content">
                            <div class="task-title">${task.title} 
                                ${task.desc ? '<i class="fas fa-caret-down expand-btn" onclick="toggleDesc(this)"></i>' : ''}
                            </div>
                            <div class="task-desc">${task.desc || ''}</div>
                        </div>
                        <i class="fas fa-times" onclick="deleteTask('${task.id}')" style="color:#eee; padding:5px;"></i>
                    `;
                    activeList.appendChild(li);
                } else {
                    hasCompleted = true;
                    li.className = 'task-item sediment';
                    li.innerHTML = `
                        <div class="check-circle"></div>
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                        </div>
                    `;
                    sedimentList.appendChild(li);
                }
            });

            harvestArea.style.display = hasCompleted ? 'block' : 'none';
        }

        function openTaskModal() { document.getElementById('task-modal').style.display = 'flex'; document.getElementById('modal-task-title').focus(); }
        function closeTaskModal() { document.getElementById('task-modal').style.display = 'none'; }
        
        function saveTaskFromModal() {
            const title = document.getElementById('modal-task-title').value.trim();
            const desc = document.getElementById('modal-task-desc').value.trim();
            if (title) {
                tasks.unshift({ id: Date.now().toString(36), title, desc, completed: false, timestamp: Date.now() });
                saveTasks(); renderTasks(); closeTaskModal();
                document.getElementById('modal-task-title').value = '';
                document.getElementById('modal-task-desc').value = '';
            }
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if(task) { task.completed = !task.completed; task.timestamp = Date.now(); saveTasks(); renderTasks(); if(navigator.vibrate) navigator.vibrate(30); }
        }

        function toggleDesc(btn) {
            const item = btn.closest('.task-item');
            item.classList.toggle('expanded');
            btn.className = item.classList.contains('expanded') ? 'fas fa-caret-up expand-btn' : 'fas fa-caret-down expand-btn';
        }

        function deleteTask(id) {
            if(confirm('Âà™Èô§Ê≠§‰ªªÂãôÔºü')) { tasks = tasks.filter(t => t.id !== id); saveTasks(); renderTasks(); }
        }

        /* --- Accumulation / Harvest Logic --- */
        function harvestTasks() {
            const completed = tasks.filter(t => t.completed);
            if(completed.length > 0 && confirm(`Â∞ÅÂ≠òÈÄô ${completed.length} ÂÄã‰ªªÂãôÂà∞ÁîüÊ∂ØÁ¥ØÁ©çÔºü`)) {
                legacyCount += completed.length;
                updateLegacyDisplay();
                tasks = tasks.filter(t => !t.completed);
                saveTasks(); renderTasks();
                // Animation effect
                const countEl = document.getElementById('total-count');
                countEl.style.animation = 'pop 0.3s';
                setTimeout(() => countEl.style.animation = 'none', 300);
            }
        }

        function updateLegacyDisplay() {
            localStorage.setItem('v36_legacy_count', legacyCount);
            document.getElementById('total-count').innerText = legacyCount;
        }

        function saveTasks() { localStorage.setItem('v36_tasks', JSON.stringify(tasks)); }

        /* --- Gacha Logic --- */
        let currentGacha = null;
        function playGacha() {
            const icon = document.getElementById('gacha-icon');
            icon.style.animation = 'pop 0.5s infinite';
            setTimeout(() => {
                icon.style.animation = 'none';
                currentGacha = gachaPool[Math.floor(Math.random() * gachaPool.length)];
                document.getElementById('gacha-title').innerText = currentGacha.title;
                document.getElementById('gacha-desc').innerText = currentGacha.desc;
                document.getElementById('gacha-result').style.display = 'block';
            }, 800);
        }
        function acceptGacha() {
            if(currentGacha) {
                tasks.unshift({id: Date.now().toString(36), title: currentGacha.title, desc: currentGacha.desc, completed: false, timestamp: Date.now()});
                saveTasks(); renderTasks(); switchTab('home');
                document.getElementById('gacha-result').style.display = 'none';
            }
        }
        function renderPool() {
            const list = document.getElementById('pool-list'); list.innerHTML = '';
            gachaPool.forEach((item, idx) => {
                list.innerHTML += `<li class="pool-item"><div><b>${item.title}</b><br><small>${item.desc}</small></div><i class="fas fa-trash" onclick="removeFromPool(${idx})" style="color:#ccc;"></i></li>`;
            });
            localStorage.setItem('v36_pool', JSON.stringify(gachaPool));
        }
        function addToPool() {
            const t = document.getElementById('pool-new-title').value.trim();
            const d = document.getElementById('pool-new-desc').value.trim();
            if(t) { gachaPool.push({title:t, desc:d}); renderPool(); document.getElementById('pool-new-title').value=''; document.getElementById('pool-new-desc').value=''; }
        }
        function removeFromPool(idx) { gachaPool.splice(idx, 1); renderPool(); }

        /* --- Journal Logic --- */
        function selectMood(m) {
            currentMood = m;
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.toggle('selected', b.innerText === m));
        }
        
        function renderJournalQuestions() {
            const area = document.getElementById('dynamic-questions-area');
            area.innerHTML = '';
            reviewQuestions.forEach((q, idx) => {
                area.innerHTML += `
                    <div class="review-question">
                        <span class="review-label">${q}</span>
                        <input type="text" class="review-input q-input" data-idx="${idx}">
                    </div>
                `;
            });
        }

        function saveJournal() {
            const qInputs = document.querySelectorAll('.q-input');
            let qa = [];
            qInputs.forEach(input => {
                qa.push({ q: reviewQuestions[input.dataset.idx], a: input.value });
            });
            const free = document.getElementById('journal-free-text').value;

            if(!currentMood && !free) { alert('Ë´ãËá≥Â∞ëÈÅ∏ÂÄãÂøÉÊÉÖÊàñÂØ´ÈªûÂ≠ó'); return; }

            const entry = {
                id: Date.now(), date: new Date().toLocaleString(),
                mood: currentMood, qa: qa, free: free
            };
            journals.unshift(entry);
            localStorage.setItem('v36_journals', JSON.stringify(journals));
            
            // Clear UI
            selectMood(''); document.getElementById('journal-free-text').value = '';
            qInputs.forEach(i => i.value = '');
            renderJournalHistory();
            alert('Êó•Ë™åÂ∑≤ÂÑ≤Â≠ò');
        }

        function renderJournalHistory() {
            const list = document.getElementById('journal-history'); list.innerHTML = '';
            journals.forEach(j => {
                let qaHtml = j.qa.map(item => `<div><small><b>${item.q}</b></small><br>${item.a || '-'}</div>`).join('<br>');
                list.innerHTML += `
                    <li class="journal-history-item">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#888; font-size:0.8rem;">
                            <span>${j.date}</span><span>${j.mood || ''}</span>
                        </div>
                        ${qaHtml}
                        ${j.free ? `<div style="margin-top:10px; border-top:1px dashed #eee; padding-top:5px;">${j.free}</div>` : ''}
                    </li>
                `;
            });
        }

        /* --- Settings Logic (Custom Questions) --- */
        function renderQuestionSettings() {
            const list = document.getElementById('questions-list'); list.innerHTML = '';
            reviewQuestions.forEach((q, idx) => {
                list.innerHTML += `<li class="settings-item"><span>${q}</span><i class="fas fa-times" onclick="removeQuestion(${idx})" style="color:#ccc;"></i></li>`;
            });
            localStorage.setItem('v36_questions', JSON.stringify(reviewQuestions));
        }
        function addQuestionTemplate() {
            const v = document.getElementById('new-question-input').value.trim();
            if(v) { reviewQuestions.push(v); renderQuestionSettings(); renderJournalQuestions(); document.getElementById('new-question-input').value=''; }
        }
        function removeQuestion(idx) { reviewQuestions.splice(idx, 1); renderQuestionSettings(); renderJournalQuestions(); }
        function resetAllData() {
            if(confirm('Ë≠¶ÂëäÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâ‰ªªÂãô„ÄÅÊó•Ë™åËàáÁ¥ØÁ©çÊï∏Â≠óÔºåÁÑ°Ê≥ïÂæ©Âéü„ÄÇÁ¢∫ÂÆöÂóéÔºü')) {
                localStorage.clear(); location.reload();
            }
        }

        /* --- Cooldown Logic --- */
        let cdInterval;
        function openCooldown() { document.getElementById('cooldown-modal').style.display = 'flex'; startTimer(); }
        function closeCooldown() { document.getElementById('cooldown-modal').style.display = 'none'; clearInterval(cdInterval); }
        function startTimer() {
            let t = 180;
            const display = document.getElementById('timer-display');
            const btn = document.getElementById('stop-cooldown-btn');
            btn.disabled = true; btn.innerText = "Ë®àÊôÇ‰∏≠..."; btn.style.background = "#ccc";
            
            clearInterval(cdInterval);
            cdInterval = setInterval(() => {
                t--;
                let m = Math.floor(t/60).toString().padStart(2,'0');
                let s = (t%60).toString().padStart(2,'0');
                display.innerText = `${m}:${s}`;
                if(t<=0) {
                    clearInterval(cdInterval);
                    btn.disabled = false; btn.innerText = "ÂÆåÊàêÂÜ∑Âçª"; btn.style.background = "var(--primary)";
                    if(navigator.vibrate) navigator.vibrate([200,100,200]);
                }
            }, 1000);
        }
        function stopCooldown() { closeCooldown(); document.getElementById('anger-input').value = ''; }

    </script>
</body>
</html>
