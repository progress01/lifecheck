<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Quest Guild v6.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Habitica-inspired Palette */
            --habit-color: #f2a900; /* Gold/Yellow */
            --daily-color: #878190; /* Grey/Silver for unchecked */
            --todo-color: #ff9f43; /* Orange */
            --primary: #4f2a93;     /* Purple */
            --bg: #f3f3f3;
            --card-bg: #ffffff;
            --text: #333;
            --danger: #ff5252;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 20px; padding-bottom: 80px;
        }

        /* --- Layout: The Dashboard --- */
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* 頂部：狀態與指引 */
        header { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        
        .profile-card {
            flex: 1; min-width: 300px; background: var(--card-bg); padding: 15px;
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary); display: flex; align-items: center; gap: 15px;
        }
        .avatar { width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        
        /* 銘文系統 (Lore) - 參考 Image 2 */
        .lore-section {
            flex: 2; min-width: 300px; background: #e8f4fd; padding: 15px;
            border-radius: 8px; border-left: 4px solid #2980b9; color: #2c3e50;
            cursor: pointer; position: relative;
        }
        .lore-section:hover { background: #d6eaf8; }
        .lore-title { font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .lore-text { font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; }

        /* 三欄式佈局 - 參考 Image 1 */
        .grid-board {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px; align-items: start;
        }

        /* 欄位樣式 */
        .column {
            background: #e0e0e0; padding: 10px; border-radius: 8px; min-height: 200px;
        }
        
        .col-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 10px; margin-bottom: 10px; font-weight: bold; color: #555; text-transform: uppercase; font-size: 0.9rem;
        }
        
        /* 清除按鈕 (針對單一分頁) */
        .clear-btn {
            background: none; border: none; color: #999; cursor: pointer; font-size: 0.8rem;
            transition: color 0.2s;
        }
        .clear-btn:hover { color: var(--danger); }

        /* 任務卡片 */
        .task-list { list-style: none; padding: 0; margin: 0; }
        
        .task-card {
            background: var(--card-bg); padding: 12px; margin-bottom: 8px;
            border-radius: 4px; display: flex; align-items: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left: 4px solid transparent;
            transition: transform 0.1s; cursor: pointer; position: relative;
        }
        .task-card:active { transform: scale(0.98); }

        /* 分類顏色 */
        .col-habit .task-card { border-left-color: var(--habit-color); }
        .col-daily .task-card { border-left-color: var(--daily-color); }
        .col-todo .task-card { border-left-color: var(--todo-color); }

        /* 內容佈局 */
        .task-check { 
            width: 24px; height: 24px; background: #eee; border-radius: 4px; 
            margin-right: 10px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; flex-shrink: 0; margin-top: 2px;
        }
        .col-habit .task-check { background: var(--habit-color); color: white; font-weight: bold; }
        .col-habit .task-check::after { content: '+'; }
        
        .task-main { flex: 1; }
        .task-title { font-size: 0.95rem; font-weight: 600; line-height: 1.3; }
        .task-desc { font-size: 0.8rem; color: #888; margin-top: 4px; display: none; }
        .task-card.expanded .task-desc { display: block; padding-top: 5px; border-top: 1px dashed #eee; }

        .task-delete { color: #ddd; padding: 5px; margin-left: 5px; }
        .task-delete:hover { color: var(--danger); }

        /* 完成狀態 */
        .task-card.completed { opacity: 0.6; background: #f9f9f9; }
        .task-card.completed .task-title { text-decoration: line-through; }
        .col-daily .task-card.completed .task-check { background: #aaa; }
        .col-todo .task-card.completed .task-check::after { content: '✔'; color: #555; }

        /* --- Fab & Modals --- */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; cursor: pointer;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; }
        
        .input-group { margin-bottom: 15px; }
        .input-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        
        .type-selector { display: flex; gap: 5px; margin-bottom: 15px; }
        .type-btn { 
            flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 6px; 
            text-align: center; cursor: pointer; font-size: 0.9rem; font-weight: bold; color: #888;
        }
        .type-btn.active[data-type="habit"] { border-color: var(--habit-color); color: var(--habit-color); background: #fffcf0; }
        .type-btn.active[data-type="daily"] { border-color: var(--daily-color); color: var(--daily-color); background: #f4f4f4; }
        .type-btn.active[data-type="todo"] { border-color: var(--todo-color); color: var(--todo-color); background: #fff5eb; }

        .btn-submit { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-close { width: 100%; padding: 10px; background: none; border: none; color: #888; margin-top: 5px; cursor: pointer; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="profile-card">
            <div class="avatar"><i class="fas fa-user-astronaut"></i></div>
            <div>
                <div style="font-size:0.8rem; color:#888;">LIFETIME LEGACY</div>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);" id="stat-legacy">0</div>
            </div>
        </div>

        <div class="lore-section" onclick="ui.openLoreModal()">
            <div class="lore-title">
                <span><i class="fas fa-scroll"></i> 冒險指引 (Context)</span>
                <i class="fas fa-pen" style="font-size:0.8rem; opacity:0.5;"></i>
            </div>
            <div class="lore-text" id="lore-display">點擊此處設定你的核心目標與背景故事...</div>
        </div>
    </header>

    <div class="grid-board">
        
        <div class="column col-habit">
            <div class="col-header">
                習慣 Habits
                <button class="clear-btn" onclick="app.clearList('habit')" title="清空習慣">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <ul id="list-habit" class="task-list"></ul>
        </div>

        <div class="column col-daily">
            <div class="col-header">
                每日 Daily
                <button class="clear-btn" onclick="app.clearList('daily')" title="清空每日任務">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <ul id="list-daily" class="task-list"></ul>
        </div>

        <div class="column col-todo">
            <div class="col-header">
                待辦 To-Do
                <button class="clear-btn" onclick="app.clearList('todo')" title="清空已完成待辦">
                    <i class="fas fa-archive"></i>
                </button>
            </div>
            <ul id="list-todo" class="task-list"></ul>
        </div>

    </div>
</div>

<div class="fab" onclick="ui.openAddModal()">
    <i class="fas fa-plus"></i>
</div>

<div id="modal-add" class="modal-overlay">
    <div class="modal">
        <h3 style="margin-top:0;">新增項目</h3>
        <div class="input-group">
            <input id="inp-title" class="input-box" placeholder="標題 (e.g. 喝水, 運動)">
        </div>
        <div class="input-group">
            <textarea id="inp-desc" class="input-box" rows="3" placeholder="詳細說明 / 為什麼要做這個？"></textarea>
        </div>
        
        <label style="font-size:0.8rem; color:#888; display:block; margin-bottom:5px;">頻率設定 (Frequency)</label>
        <div class="type-selector">
            <div class="type-btn active" data-type="habit" onclick="ui.selectType('habit')">習慣<br><small>無限次</small></div>
            <div class="type-btn" data-type="daily" onclick="ui.selectType('daily')">每日<br><small>午夜重置</small></div>
            <div class="type-btn" data-type="todo" onclick="ui.selectType('todo')">待辦<br><small>單次</small></div>
        </div>

        <button class="btn-submit" onclick="app.addTask()">建立</button>
        <button class="btn-close" onclick="ui.closeAddModal()">取消</button>
    </div>
</div>

<div id="modal-lore" class="modal-overlay">
    <div class="modal">
        <h3>編輯冒險指引</h3>
        <textarea id="inp-lore" class="input-box" rows="6" placeholder="寫下你的目標、動機或世界觀..."></textarea>
        <button class="btn-submit" onclick="app.saveLore()">保存</button>
        <button class="btn-close" onclick="ui.closeLoreModal()">取消</button>
    </div>
</div>

<script>
    // --- Data Store ---
    const store = {
        db: JSON.parse(localStorage.getItem('lqe_v6_1')) || {
            tasks: [], 
            legacy: 0,
            lore: "歡迎來到公會大廳。\n這裡是你管理人生任務的指揮中心。\n\n點擊這裡編輯你的長期目標或世界觀設定。",
            lastLogin: Date.now()
        },
        save() { 
            localStorage.setItem('lqe_v6_1', JSON.stringify(this.db)); 
            app.render(); 
        },
        checkReset() {
            const today = new Date().toDateString();
            const last = new Date(this.db.lastLogin).toDateString();
            if(today !== last) {
                // Reset Dailies only
                let count = 0;
                this.db.tasks.forEach(t => { if(t.type === 'daily') { t.completed = false; count++; } });
                this.db.lastLogin = Date.now();
                this.save();
                if(count > 0) alert('☀️ 新的一天：每日任務已重置！');
            }
        }
    };

    // --- App Logic ---
    let currentType = 'habit';

    const app = {
        init() {
            // Default Data Injection (Fix for "empty screen" issue)
            if (store.db.tasks.length === 0) {
                store.db.tasks = [
                    {id: 1, type: 'habit', title: '喝水', desc: '保持水分', completed: false},
                    {id: 2, type: 'daily', title: '核心任務筆記', desc: '檢視今日重點', completed: false},
                    {id: 3, type: 'todo', title: '設定這個 App', desc: '熟悉操作介面', completed: false}
                ];
                store.save();
            }
            store.checkReset();
            this.render();
        },

        render() {
            // Render Stats
            document.getElementById('stat-legacy').innerText = store.db.legacy;
            document.getElementById('lore-display').innerText = store.db.lore;
            document.getElementById('inp-lore').value = store.db.lore;

            // Clear Lists
            document.getElementById('list-habit').innerHTML = '';
            document.getElementById('list-daily').innerHTML = '';
            document.getElementById('list-todo').innerHTML = '';

            // Render Tasks
            store.db.tasks.forEach(t => {
                const li = document.createElement('li');
                li.className = `task-card ${t.completed ? 'completed' : ''}`;
                li.onclick = (e) => { 
                    if(!e.target.classList.contains('task-check') && !e.target.classList.contains('task-delete')) {
                        li.classList.toggle('expanded');
                    }
                };
                
                li.innerHTML = `
                    <div class="task-check" onclick="app.check('${t.id}')"></div>
                    <div class="task-main">
                        <div class="task-title">${t.title}</div>
                        <div class="task-desc">${t.desc || '無詳細說明'}</div>
                    </div>
                    <i class="fas fa-times task-delete" onclick="app.del('${t.id}')"></i>
                `;
                
                document.getElementById(`list-${t.type}`).appendChild(li);
            });
        },

        addTask() {
            const title = document.getElementById('inp-title').value.trim();
            const desc = document.getElementById('inp-desc').value.trim();
            if (title) {
                store.db.tasks.push({
                    id: Date.now().toString(36),
                    type: currentType,
                    title: title,
                    desc: desc,
                    completed: false
                });
                store.save();
                ui.closeAddModal();
                document.getElementById('inp-title').value = '';
                document.getElementById('inp-desc').value = '';
            }
        },

        check(id) {
            const t = store.db.tasks.find(x => x.id == id);
            if (!t) return;

            if (t.type === 'habit') {
                // Habits just add stats, don't toggle
                store.db.legacy++;
                // Visual feedback only
                alert('習慣 +1! (累積: ' + store.db.legacy + ')');
            } else {
                // Toggle state
                t.completed = !t.completed;
                if (t.completed && t.type === 'todo') {
                    store.db.legacy++; // Completing a todo adds legacy
                }
            }
            store.save();
        },

        del(id) {
            if (confirm('確定移除此項目？')) {
                store.db.tasks = store.db.tasks.filter(x => x.id != id);
                store.save();
            }
        },

        saveLore() {
            store.db.lore = document.getElementById('inp-lore').value;
            store.save();
            ui.closeLoreModal();
        },

        // Clean specific lists (Addressing storage anxiety)
        clearList(type) {
            if (confirm(`確定要清空「${type.toUpperCase()}」列表嗎？`)) {
                if (type === 'todo') {
                    // For To-Do, usually only clear completed
                    if(confirm('只清除「已完成」項目嗎？(取消則清除全部)')) {
                        store.db.tasks = store.db.tasks.filter(t => !(t.type === 'todo' && t.completed));
                    } else {
                        store.db.tasks = store.db.tasks.filter(t => t.type !== 'todo');
                    }
                } else {
                    // For Habits/Dailies, remove all
                    store.db.tasks = store.db.tasks.filter(t => t.type !== type);
                }
                store.save();
            }
        }
    };

    // --- UI Logic ---
    const ui = {
        openAddModal: () => document.getElementById('modal-add').style.display = 'flex',
        closeAddModal: () => document.getElementById('modal-add').style.display = 'none',
        
        openLoreModal: () => document.getElementById('modal-lore').style.display = 'flex',
        closeLoreModal: () => document.getElementById('modal-lore').style.display = 'none',

        selectType: (type) => {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn[data-type="${type}"]`).classList.add('active');
        }
    };

    // Boot
    app.init();

</script>
</body>
</html>
