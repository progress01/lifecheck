<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mind Sanctuary v5 Lite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. CSS è®Šæ•¸èˆ‡åŸºç¤è¨­å®š --- */
        :root {
            --primary: #2c3e50;
            --accent: #e67e22;
            --danger: #c0392b;
            --success: #27ae60;
            --stone: #7f8c8d;
            --bg-glass: rgba(255, 255, 255, 0.92);
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --nav-h: calc(65px + env(safe-area-inset-bottom, 20px));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: #dfe6e9; color: var(--primary);
        }

        /* --- 2. Canvas èƒŒæ™¯å±¤ --- */
        #world-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 45vh;
            z-index: 0; pointer-events: none;
        }

        /* --- 3. UI ä½ˆå±€å±¤ --- */
        .app-layout {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; z-index: 10;
        }

        .header-spacer { flex: 0 0 40vh; transition: flex 0.4s ease; }
        .header-spacer.collapsed { flex: 0 0 10vh; } /* å…¨è¢å¹•æ™‚ç¸®å° */

        .main-sheet {
            flex: 1; background: var(--bg-glass); backdrop-filter: blur(10px);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
            padding: 20px; padding-bottom: calc(var(--nav-h) + 20px);
            overflow-y: auto; scroll-behavior: smooth;
            transition: transform 0.3s;
        }

        /* --- 4. é€šç”¨å…ƒä»¶ --- */
        h2 { font-size: 1rem; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; margin: 25px 0 10px 0; border-left: 3px solid var(--accent); padding-left: 8px; }
        
        .btn { border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: transform 0.1s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(44,62,80,0.3); }
        .btn-accent { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(230,126,34,0.3); }
        .btn-ghost { background: transparent; color: #888; border: 1px solid #ddd; }

        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: #fdfdfd; font-size: 1rem; margin-bottom: 10px; transition: 0.3s; }
        .input-box:focus { border-color: var(--primary); background: white; outline: none; }

        /* --- 5. ä»»å‹™åˆ—è¡¨æ¨£å¼ --- */
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; align-items: flex-start; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: all 0.2s;
        }
        
        .check-circle {
            width: 24px; height: 24px; border: 2px solid var(--accent); border-radius: 50%;
            margin-right: 12px; margin-top: 2px; flex-shrink: 0; cursor: pointer;
        }
        
        .task-content { flex: 1; }
        .task-title { font-size: 1rem; font-weight: 600; line-height: 1.4; }
        .task-desc { font-size: 0.85rem; color: #888; margin-top: 4px; display: none; white-space: pre-wrap; padding-top: 4px; border-top: 1px dashed #eee; }
        .task-item.expanded .task-desc { display: block; }
        
        /* å°å­˜æ¨£å¼ */
        .task-item.sediment { background: #f0f2f5; color: #95a5a6; transform: scale(0.99); box-shadow: none; border: none; }
        .task-item.sediment .check-circle { border-color: #bdc3c7; background: #bdc3c7; width: 12px; height: 12px; margin-right: 15px; pointer-events: none; }
        .task-item.sediment .task-title { text-decoration: line-through; }

        /* --- 6. æ¨™ç±¤èˆ‡åŠŸèƒ½å€ --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        .fab {
            position: fixed; bottom: calc(var(--nav-h) + 20px); right: 20px;
            width: 56px; height: 56px; background: var(--accent); color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; box-shadow: 0 5px 15px rgba(230,126,34,0.4); z-index: 100;
            transition: transform 0.2s;
        }
        .fab:active { transform: rotate(90deg); }

        /* --- 7. ç‰¹æ®ŠåŠŸèƒ½å€ (Void, Gacha, Focus) --- */
        .void-box { background: #2d3436; color: #dfe6e9; padding: 30px; border-radius: 20px; text-align: center; }
        .focus-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.98); z-index: 3000;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .gacha-wheel { font-size: 4rem; color: var(--primary); margin: 20px; transition: transform 2s cubic-bezier(0.1, 0.7, 0.1, 1); }

        /* --- 8. å°èˆªèˆ‡å½ˆçª— --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; padding-top: 12px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.03); z-index: 1000;
        }
        .nav-item { text-align: center; color: #b2bec3; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; animation: popUp 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="world-canvas"></canvas>

    <div class="app-layout">
        <div class="header-spacer" id="header-spacer" onclick="app.toggleView()"></div>
        
        <div class="main-sheet">
            
            <div id="tab-sanctuary" class="tab-content active">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1 style="margin:0; font-size:1.4rem;">å¿ƒéˆè–æ®¿</h1>
                    <div style="font-size:0.8rem; background:#eee; padding:4px 8px; border-radius:6px;">
                        Lv.<span id="stat-lvl">1</span> | ğŸ§± <span id="stat-bricks">0</span>
                    </div>
                </div>

                <h2>é€²è¡Œä¸­ (Active)</h2>
                <ul id="list-active" class="task-list"></ul>
                
                <div id="harvest-area" style="text-align:center; margin:30px 0; display:none;">
                    <button class="btn btn-primary" onclick="app.harvest()">
                        <i class="fas fa-layer-group"></i> å°å­˜ä¸¦ç¯‰å¡”
                    </button>
                    <p style="font-size:0.8rem; color:#888; margin-top:5px;">å°‡å·²å®Œæˆçš„ä»»å‹™è½‰åŒ–ç‚ºé«˜å¡”åŸºçŸ³</p>
                </div>

                <h2>æ²ˆç©å±¤ (Legacy)</h2>
                <ul id="list-sediment" class="task-list"></ul>
            </div>

            <div id="tab-gacha" class="tab-content">
                <div style="text-align:center; padding:30px 0;">
                    <i class="fas fa-dharmachakra gacha-wheel" id="gacha-wheel"></i>
                    <br>
                    <button class="btn btn-accent" onclick="app.spinGacha()">å‘½é‹æŒ‡å¼•</button>
                    
                    <div id="gacha-result" style="display:none; margin-top:20px; border:2px solid var(--accent); padding:15px; border-radius:12px; text-align:left;">
                        <h3 id="res-title" style="margin:0; color:var(--primary)"></h3>
                        <p id="res-desc" style="color:#666; font-size:0.9rem; margin:5px 0 15px 0;"></p>
                        <button class="btn btn-primary" style="width:100%" onclick="app.acceptGacha()">æ¥å—æŒ‘æˆ°</button>
                    </div>
                </div>
                <h2>æŒ‘æˆ°æ± ç®¡ç†</h2>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input id="pool-new" class="input-box" placeholder="è¼¸å…¥æ–°æŒ‘æˆ°..." style="margin:0;">
                    <button class="btn btn-ghost" onclick="app.addPool()">+</button>
                </div>
                <ul id="list-pool" class="task-list"></ul>
            </div>

            <div id="tab-void" class="tab-content">
                <h2>æƒ…ç·’ç¢ç´™æ©Ÿ</h2>
                <div class="void-box">
                    <p style="opacity:0.7; margin-top:0;">åœ¨é€™è£¡å¯«ä¸‹ç„¦æ…®ï¼Œç„¶å¾Œæ¯€æ»…å®ƒã€‚</p>
                    <textarea id="void-input" class="input-box" rows="4" style="background:rgba(255,255,255,0.1); color:white; border:none;"></textarea>
                    <button class="btn" style="background:#c0392b; color:white; width:100%;" onclick="app.shred()">æ¯€æ»…å¿µé ­</button>
                </div>

                <h2>å°ˆæ³¨çµç•Œ</h2>
                <div style="background:white; padding:20px; border-radius:16px; text-align:center; margin-top:10px;">
                    <i class="fas fa-stopwatch" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                    <p style="font-size:0.9rem; color:#666;">é–‹å•Ÿ 25 åˆ†é˜çµ•å°å°ˆæ³¨ã€‚çµç•Œé–‹å•Ÿå¾Œç„¡æ³•æ“ä½œã€‚</p>
                    <button class="btn btn-primary" style="width:100%;" onclick="app.startFocus()">é–‹å•Ÿçµç•Œ</button>
                </div>
            </div>

            <div id="tab-journal" class="tab-content">
                <div style="background:white; padding:20px; border-radius:16px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:1.8rem; margin-bottom:15px;">
                        <span onclick="app.setMood('ğŸ˜­')" style="cursor:pointer; opacity:0.6;">ğŸ˜­</span>
                        <span onclick="app.setMood('ğŸ˜')" style="cursor:pointer; opacity:0.6;">ğŸ˜</span>
                        <span onclick="app.setMood('ğŸ™‚')" style="cursor:pointer; opacity:0.6;">ğŸ™‚</span>
                        <span onclick="app.setMood('ğŸ¤©')" style="cursor:pointer; opacity:0.6;">ğŸ¤©</span>
                        <span onclick="app.setMood('ğŸ§˜')" style="cursor:pointer; opacity:0.6;">ğŸ§˜</span>
                    </div>
                    <div id="journal-questions"></div>
                    <textarea id="journal-note" class="input-box" rows="3" placeholder="è‡ªç”±æ›¸å¯«..."></textarea>
                    <button class="btn btn-primary" style="width:100%;" onclick="app.saveJournal()">è¨˜éŒ„ä»Šå¤©</button>
                </div>
                <h2>æ­·å²æ—¥èªŒ</h2>
                <ul id="list-journal" class="task-list"></ul>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2>æª¢è¨å•é¡Œè¨­å®š</h2>
                <ul id="list-q-settings" class="task-list"></ul>
                <div style="display:flex; gap:10px;">
                    <input id="new-q" class="input-box" placeholder="æ–°å¢å•é¡Œ..." style="margin:0;">
                    <button class="btn btn-ghost" onclick="app.addQuestion()">+</button>
                </div>

                <h2>è³‡æ–™å®‰å…¨</h2>
                <div style="margin-top:20px;">
                    <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="app.exportData()">å‚™ä»½è³‡æ–™ (JSON)</button>
                    <button class="btn" style="background:var(--danger); color:white; width:100%;" onclick="app.resetData()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>

        </div>
    </div>

    <div class="fab" onclick="ui.openModal('task')"><i class="fas fa-plus"></i></div>

    <div id="modal-task" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0;">æ–°å¢åŸºçŸ³</h3>
            <input id="inp-title" class="input-box" placeholder="æ¨™é¡Œ (å¿…å¡«)">
            <textarea id="inp-desc" class="input-box" rows="3" placeholder="è©³ç´°å…§å®¹ (é¸å¡«)" style="resize:none;"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="app.addTask()">æ–°å¢</button>
                <button class="btn btn-ghost" style="flex:1" onclick="ui.closeModal('task')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="focus-overlay" class="focus-overlay">
        <div style="font-size:4rem; font-weight:100;" id="focus-timer">25:00</div>
        <p style="opacity:0.7;">æ­£åœ¨å°ˆæ³¨ä¸­...</p>
        <button class="btn btn-ghost" style="color:white; border-color:white; margin-top:20px;" onclick="app.stopFocus()">æ”¾æ£„</button>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="ui.switchTab('sanctuary', this)"><i class="fas fa-dungeon"></i>è–æ®¿</div>
        <div class="nav-item" onclick="ui.switchTab('gacha', this)"><i class="fas fa-dice"></i>å‘½é‹</div>
        <div class="nav-item" onclick="ui.switchTab('void', this)"><i class="fas fa-ghost"></i>æ·¨åŒ–</div>
        <div class="nav-item" onclick="ui.switchTab('journal', this)"><i class="fas fa-book-open"></i>æ—¥èªŒ</div>
        <div class="nav-item" onclick="ui.switchTab('settings', this)"><i class="fas fa-cog"></i>è¨­å®š</div>
    </nav>

    <script>
        /**
         * Mind Sanctuary v5.0 Lite
         * Core Modules: Store, SoundFX, Renderer, App, UI
         */

        // --- 1. SoundFX (8-bit Retro Audio) ---
        class SoundFX {
            constructor() { this.ctx = null; }
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
            
            beep(freq, type, dur) {
                if(!this.ctx) this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            }

            playClick() { this.beep(800, 'sine', 0.05); }
            playSuccess() { 
                this.beep(523, 'square', 0.1); 
                setTimeout(()=>this.beep(659, 'square', 0.1), 100); 
                setTimeout(()=>this.beep(784, 'square', 0.2), 200); 
            }
            playTrash() { this.beep(150, 'sawtooth', 0.3); }
            playWin() { [440,554,659,880].forEach((f,i) => setTimeout(()=>this.beep(f,'triangle',0.1), i*80)); }
        }

        // --- 2. Canvas Renderer (The Monument) ---
        class Renderer {
            constructor(canvasId, store) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.store = store;
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }
            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight * 0.5; this.draw(); }
            
            draw() {
                const { width: w, height: h } = this.canvas;
                const ctx = this.ctx;
                const count = this.store.db.legacyCount;

                // Sky Gradient (Day/Night)
                const hr = new Date().getHours();
                const grad = ctx.createLinearGradient(0,0,0,h);
                if(hr >= 6 && hr < 18) { grad.addColorStop(0, '#89f7fe'); grad.addColorStop(1, '#66a6ff'); }
                else { grad.addColorStop(0, '#0f2027'); grad.addColorStop(1, '#2c3e50'); }
                ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);

                // Draw Tower
                const bw = 30, bh = 15;
                const cols = Math.ceil(w/bw);
                const startY = h; 
                let drawn = 0, row = 0;

                ctx.fillStyle = '#95a5a6'; ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                while(drawn < count) {
                    let inRow = Math.min(cols, count - drawn);
                    for(let i=0; i<inRow; i++) {
                        // Center the tower
                        const x = (w - (inRow*bw))/2 + i*bw;
                        const y = startY - (row*bh) - bh;
                        
                        // Brick variation
                        ctx.fillStyle = `hsl(210, 10%, ${50 + (i%5)*5}%)`;
                        ctx.fillRect(x,y,bw,bh);
                        ctx.strokeRect(x,y,bw,bh);
                    }
                    drawn += inRow; row++;
                }
            }
        }

        // --- 3. Data Store ---
        class Store {
            constructor() {
                this.db = JSON.parse(localStorage.getItem('ms_v5_lite')) || {
                    tasks: [], legacyCount: 0, journals: [], 
                    pool: [{t:"æ•´ç†æ¡Œé¢",d:"3åˆ†é˜"},{t:"å–æ°´",d:"500cc"}],
                    config: { questions: ["ä»Šå¤©æœ€æ£’çš„äº‹ï¼Ÿ", "å¯ä»¥æ”¹é€²çš„åœ°æ–¹ï¼Ÿ"] }
                };
            }
            save() { localStorage.setItem('ms_v5_lite', JSON.stringify(this.db)); }
        }

        // --- 4. Main App Logic ---
        class App {
            constructor() {
                this.store = new Store();
                this.sfx = new SoundFX();
                this.renderer = new Renderer('world-canvas', this.store);
                this.currentMood = '';
                this.refresh();
            }

            refresh() {
                ui.renderTasks(this.store.db.tasks);
                ui.renderStats(this.store.db.legacyCount);
                ui.renderPool(this.store.db.pool);
                ui.renderJournal(this.store.db);
                ui.renderSettings(this.store.db.config);
                this.renderer.draw();
            }

            // Tasks
            addTask() {
                const t = document.getElementById('inp-title').value;
                const d = document.getElementById('inp-desc').value;
                if(t) {
                    this.store.db.tasks.unshift({id:Date.now().toString(36), t, d, completed:false, time:Date.now()});
                    this.store.save(); this.refresh(); ui.closeModal('task');
                    document.getElementById('inp-title').value=''; document.getElementById('inp-desc').value='';
                    this.sfx.playClick();
                }
            }
            toggleTask(id) {
                const t = this.store.db.tasks.find(x=>x.id===id);
                if(t) { t.completed = !t.completed; t.time = Date.now(); this.store.save(); this.refresh(); this.sfx.playClick(); }
            }
            harvest() {
                const done = this.store.db.tasks.filter(t=>t.completed);
                if(done.length && confirm(`å°å­˜ ${done.length} å€‹åŸºçŸ³ï¼Ÿ`)) {
                    this.store.db.legacyCount += done.length;
                    this.store.db.tasks = this.store.db.tasks.filter(t=>!t.completed);
                    this.store.save(); this.refresh(); this.sfx.playSuccess();
                }
            }
            deleteTask(id) {
                if(confirm('åˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) {
                    this.store.db.tasks = this.store.db.tasks.filter(t=>t.id!==id);
                    this.store.save(); this.refresh(); this.sfx.playTrash();
                }
            }

            // Gacha
            spinGacha() {
                const el = document.getElementById('gacha-wheel');
                el.style.transform = 'rotate(720deg)';
                this.sfx.playClick();
                setTimeout(()=>{
                    el.style.transform = 'rotate(0deg)';
                    const item = this.store.db.pool[Math.floor(Math.random()*this.store.db.pool.length)];
                    this.tempGacha = item;
                    document.getElementById('res-title').innerText = item.t;
                    document.getElementById('res-desc').innerText = item.d;
                    document.getElementById('gacha-result').style.display = 'block';
                    this.sfx.playWin();
                }, 800);
            }
            acceptGacha() {
                if(this.tempGacha) {
                    this.store.db.tasks.unshift({id:Date.now().toString(36), t:this.tempGacha.t, d:this.tempGacha.d, completed:false, time:Date.now()});
                    this.store.save(); this.refresh(); 
                    document.getElementById('gacha-result').style.display='none';
                    ui.switchTab('sanctuary', document.querySelector('.nav-item'));
                }
            }
            addPool() {
                const v = document.getElementById('pool-new').value;
                if(v) { this.store.db.pool.push({t:v, d:''}); this.store.save(); this.refresh(); document.getElementById('pool-new').value=''; }
            }
            delPool(idx) { this.store.db.pool.splice(idx,1); this.store.save(); this.refresh(); }

            // Void
            shred() {
                const el = document.getElementById('void-input');
                if(el.value) {
                    this.sfx.playTrash();
                    el.style.transition = '0.5s'; el.style.transform = 'scale(0) rotate(10deg)';
                    setTimeout(()=>{ el.value=''; el.style.transform='none'; alert('å¿µé ­å·²ç²‰ç¢'); }, 500);
                }
            }
            startFocus() {
                document.getElementById('focus-overlay').style.display='flex';
                let s = 25*60;
                this.timer = setInterval(()=>{
                    s--; document.getElementById('focus-timer').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                    if(s<=0) { clearInterval(this.timer); alert('å°ˆæ³¨çµæŸ'); this.stopFocus(); this.sfx.playSuccess(); }
                }, 1000);
            }
            stopFocus() { clearInterval(this.timer); document.getElementById('focus-overlay').style.display='none'; }

            // Journal
            setMood(m) { this.currentMood=m; this.sfx.playClick(); alert('å¿ƒæƒ…å·²é¸æ“‡: '+m); }
            saveJournal() {
                const note = document.getElementById('journal-note').value;
                const qInputs = document.querySelectorAll('.q-input');
                let qa = []; qInputs.forEach(i=>qa.push({q:i.dataset.q, a:i.value}));
                
                if(!this.currentMood && !note) return alert('è«‹å¯«é»æ±è¥¿æˆ–é¸å¿ƒæƒ…');
                this.store.db.journals.unshift({id:Date.now(), date:new Date().toLocaleString(), m:this.currentMood, qa, note});
                this.store.save(); this.refresh(); this.sfx.playSuccess();
                document.getElementById('journal-note').value='';
                qInputs.forEach(i=>i.value='');
            }

            // Settings
            addQuestion() {
                const v = document.getElementById('new-q').value;
                if(v) { this.store.db.config.questions.push(v); this.store.save(); this.refresh(); document.getElementById('new-q').value=''; }
            }
            delQuestion(idx) { this.store.db.config.questions.splice(idx,1); this.store.save(); this.refresh(); }
            
            exportData() {
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.store.db));
                a.download = "mind_backup.json"; a.click();
            }
            resetData() { if(confirm('åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.removeItem('ms_v5_lite'); location.reload(); } }
            
            toggleView() { document.querySelector('.header-spacer').classList.toggle('collapsed'); }
        }

        // --- 5. UI Renderer ---
        const ui = {
            switchTab: (id, el) => {
                document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
                document.getElementById('tab-'+id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
                el.classList.add('active');
                document.querySelector('.fab').style.display = id==='sanctuary'?'flex':'none';
                app.sfx.playClick();
            },
            openModal: (id) => document.getElementById('modal-'+id).style.display='flex',
            closeModal: (id) => document.getElementById('modal-'+id).style.display='none',
            
            renderTasks: (list) => {
                const act = document.getElementById('list-active');
                const sed = document.getElementById('list-sediment');
                act.innerHTML = ''; sed.innerHTML = '';
                let hasDone = false;

                list.sort((a,b)=>b.time-a.time).forEach(t => {
                    if(!t.completed) {
                        act.innerHTML += `
                        <li class="task-item" onclick="this.classList.toggle('expanded')">
                            <div class="check-circle" onclick="event.stopPropagation(); app.toggleTask('${t.id}')"></div>
                            <div class="task-content">
                                <div class="task-title">${t.t} ${t.d?'<i class="fas fa-caret-down" style="color:#ccc"></i>':''}</div>
                                <div class="task-desc">${t.d}</div>
                            </div>
                            <i class="fas fa-times" style="color:#eee; padding:5px;" onclick="event.stopPropagation(); app.deleteTask('${t.id}')"></i>
                        </li>`;
                    } else {
                        hasDone = true;
                        sed.innerHTML += `<li class="task-item sediment"><div class="check-circle"></div><div class="task-title">${t.t}</div></li>`;
                    }
                });
                document.getElementById('harvest-area').style.display = hasDone ? 'block' : 'none';
            },
            renderStats: (n) => {
                document.getElementById('stat-bricks').innerText = n;
                document.getElementById('stat-lvl').innerText = Math.floor(Math.sqrt(n))+1;
            },
            renderPool: (list) => {
                const ul = document.getElementById('list-pool'); ul.innerHTML='';
                list.forEach((p,i)=> ul.innerHTML+=`<li class="task-item"><div class="task-content"><b>${p.t}</b><br><small>${p.d}</small></div><i class="fas fa-trash" style="color:#ccc" onclick="app.delPool(${i})"></i></li>`);
            },
            renderJournal: (db) => {
                const qDiv = document.getElementById('journal-questions'); qDiv.innerHTML='';
                db.config.questions.forEach(q => qDiv.innerHTML+=`<div style="margin-bottom:5px;font-weight:bold;font-size:0.9rem;">${q}</div><input class="input-box q-input" data-q="${q}">`);
                
                const ul = document.getElementById('list-journal'); ul.innerHTML='';
                db.journals.forEach(j => {
                    let qaStr = j.qa.map(x=>`<div><small>${x.q}</small><br>${x.a}</div>`).join('');
                    ul.innerHTML += `<li class="task-item" style="display:block;"><div style="color:#999;font-size:0.8rem;margin-bottom:5px;">${j.date} ${j.m}</div>${qaStr}<div style="margin-top:5px;border-top:1px dashed #eee;padding-top:5px;">${j.note}</div></li>`;
                });
            },
            renderSettings: (cfg) => {
                const ul = document.getElementById('list-q-settings'); ul.innerHTML='';
                cfg.questions.forEach((q,i) => ul.innerHTML+=`<li class="task-item">${q} <i class="fas fa-trash" style="color:#c0392b" onclick="app.delQuestion(${i})"></i></li>`);
            }
        };

        const app = new App();
    </script>
</body>
</html>
