<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Daily Retro</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* --- Mobile Reset & Base --- */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px 16px 100px 16px;
            margin: 0;
            min-height: 100vh;
        }

        /* --- Header --- */
        header { 
            text-align: left; width: 100%; margin-bottom: 20px; padding-left: 5px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; flex-direction: column; }
        h1 { margin: 0; font-size: 1.8rem; color: #fff; font-weight: 800; letter-spacing: -0.5px; }
        .date-display { color: #8b949e; font-size: 0.95rem; margin-top: 4px; font-weight: 500; }
        
        .settings-btn {
            background: rgba(255,255,255,0.1); border: none; color: #c9d1d9;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; transition: background 0.2s;
        }
        .settings-btn:active { background: rgba(255,255,255,0.2); }

        /* --- Cards & Layout --- */
        .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        
        /* --- Checklist Items --- */
        .checklist-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid #21262d;
            cursor: pointer; transition: background 0.2s;
        }
        .checklist-item:active { background: rgba(255,255,255,0.03); }
        .checklist-item:last-child { border-bottom: none; }
        
        .check-content { flex: 1; padding-right: 15px; }
        .check-label { font-size: 1.1rem; color: #e6edf3; font-weight: 600; display: block; margin-bottom: 4px; }
        .check-sub { font-size: 0.85rem; color: #8b949e; line-height: 1.3; }

        /* --- Custom Toggle Switch --- */
        .toggle-switch { position: relative; width: 56px; height: 32px; flex-shrink: 0; pointer-events: none; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363d; transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1); border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 3px; bottom: 3px; background-color: white; transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .checklist-item.checked .slider { background-color: #238636; }
        .checklist-item.checked .slider:before { transform: translateX(24px); }
        .checklist-item.checked .check-label { color: #3fb950; }

        /* --- Inputs --- */
        .section-title { font-size: 0.9rem; color: #58a6ff; font-weight: bold; margin-top: 25px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .text-input {
            width: 100%; background: #0d1117; border: 1px solid #30363d; color: #fff;
            padding: 16px; border-radius: 12px; font-size: 16px;
            box-sizing: border-box; resize: none; -webkit-appearance: none;
        }
        .text-input:focus { outline: none; border-color: #58a6ff; ring: 2px solid rgba(88, 166, 255, 0.3); }

        /* --- Buttons --- */
        .fab-container {
            position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 90;
            max-width: 600px; margin: 0 auto;
        }
        .action-btn {
            background: #238636; color: #fff; border: none; padding: 18px; border-radius: 50px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px rgba(35, 134, 54, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.96); }
        
        /* Secondary Button (Outline) */
        .btn-outline {
            background: transparent; border: 1px solid #30363d; color: #8b949e;
            padding: 15px; border-radius: 50px; font-size: 1rem; cursor: pointer;
            width: 100%; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-outline:active { background: rgba(255,255,255,0.05); color: #c9d1d9; }

        /* --- Result Card --- */
        .result-card {
            background: linear-gradient(145deg, #161b22, #0d1117);
            border: 2px solid #30363d; border-radius: 16px; padding: 30px 20px;
            text-align: center; display: none; position: relative; overflow: hidden;
            margin-bottom: 80px;
        }
        .result-card.S { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.15); }
        .result-card.A { border-color: #238636; }
        
        .rank-badge { font-size: 5rem; font-weight: 900; margin: 15px 0; line-height: 1; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .rank-S { color: #ffd700; background: -webkit-linear-gradient(#ffd700, #ffa500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .rank-A { color: #3fb950; }
        .rank-B { color: #58a6ff; }
        .rank-C { color: #8b949e; }

        .summary-text { color: #e6edf3; font-size: 1.2rem; margin: 20px 0; font-style: italic; white-space: pre-wrap; line-height: 1.5; }
        .next-step { background: rgba(56, 139, 253, 0.1); color: #58a6ff; padding: 15px; border-radius: 12px; font-size: 1rem; margin-top: 20px; border: 1px dashed rgba(88, 166, 255, 0.4); text-align: left; }
        
        /* --- Settings Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-card {
            background: #161b22; border: 1px solid #30363d; border-radius: 16px;
            width: 90%; max-width: 400px; padding: 20px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: #fff; }
        .modal-group { margin-bottom: 15px; }
        .modal-label { font-size: 0.8rem; color: #8b949e; display: block; margin-bottom: 5px; }
        .modal-input {
            width: 100%; background: #0d1117; border: 1px solid #30363d; color: #fff;
            padding: 10px; border-radius: 8px; font-size: 14px; margin-bottom: 5px;
        }
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save { background: #238636; color: #fff; border: none; padding: 12px; border-radius: 8px; flex: 1; font-weight: bold; }
        .btn-cancel { background: #30363d; color: #c9d1d9; border: none; padding: 12px; border-radius: 8px; flex: 1; }

        /* --- History --- */
        .history-list { margin-top: 10px; border-top: 1px solid #21262d; padding-top: 20px; padding-bottom: 80px;}
        .history-item { 
            background: #161b22; padding: 16px; border-radius: 12px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #30363d;
        }
        .del-btn { background: rgba(255, 255, 255, 0.05); border: none; color: #8b949e; cursor: pointer; padding: 8px 12px; border-radius: 8px; font-size: 14px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <div class="date-display" id="date-display">Monday, Jan 01</div>
            <h1>Daily Retro</h1>
        </div>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
    </header>

    <div id="input-view">
        <div class="card">
            <div class="checklist-item" onclick="toggleRow(this, 'check-1')">
                <div class="check-content">
                    <span class="check-label" id="label-1">ğŸ‘€ å¯è¦–åŒ–ç›®æ¨™</span>
                    <span class="check-sub" id="sub-1">æ›¸æœ¬æ”¾åœ¨æ¡Œä¸Š/é¡¯çœ¼è™•ï¼Ÿ</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="check-1">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="checklist-item" onclick="toggleRow(this, 'check-2')">
                <div class="check-content">
                    <span class="check-label" id="label-2">âš“ï¸ åŸ·è¡ŒéŒ¨é»</span>
                    <span class="check-sub" id="sub-2">æ—¢å®šå‹•ä½œå¾Œç«‹åˆ»é–‹å§‹ï¼Ÿ</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="check-2">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="checklist-item" onclick="toggleRow(this, 'check-3')">
                <div class="check-content">
                    <span class="check-label" id="label-3">ğŸ“µ æ‹’çµ•æ‰‹æ©Ÿ</span>
                    <span class="check-sub" id="sub-3">ä¼‘æ¯æ™‚é–“æ²’æ»‘æ‰‹æ©Ÿï¼Ÿ</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="check-3">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="checklist-item" onclick="toggleRow(this, 'check-4')">
                <div class="check-content">
                    <span class="check-label" id="label-4">â³ å®Œæˆå¾®è¡Œå‹•</span>
                    <span class="check-sub" id="sub-4">å°ˆæ³¨è‡³å°‘ 15 åˆ†é˜ï¼Ÿ</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="check-4">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="section-title">ğŸ’¡ ä»Šæ—¥äº®é» (Highlight)</div>
        <textarea id="summary-input" class="text-input" rows="2" placeholder="å­¸æœƒäº†ä»€éº¼..."></textarea>

        <div class="section-title">ğŸš€ æ˜æ—¥é ç´„ (Anchor)</div>
        <input type="text" id="anchor-input" class="text-input" placeholder="ä¾‹å¦‚ï¼šæ³¡å®Œå’–å•¡å¾Œ...">
        
        <div class="fab-container">
            <button class="action-btn" onclick="generateReport()">
                <span>âœ¨ ç”Ÿæˆæˆ°å ±</span>
            </button>
        </div>
        
        <div class="history-list" id="history-container">
            <div class="section-title" style="margin-top:0;">ğŸ“œ æ­·å²ç´€éŒ„</div>
            <div id="history-items"></div>
        </div>
    </div>

    <div id="result-view" class="result-card hidden">
        <div style="font-size:12px; color:#8b949e; text-transform:uppercase; letter-spacing:2px; font-weight:bold;">Daily Performance</div>
        <div class="date-display" id="res-date" style="margin-bottom:10px;"></div>
        
        <div class="rank-badge" id="res-rank">S</div>
        
        <div style="display:flex; justify-content:center; gap:8px; margin-bottom:15px; opacity:0.8;">
            <span id="res-stars" style="color:#e6edf3; font-size:14px; letter-spacing:3px;"></span>
        </div>

        <div class="summary-text" id="res-summary"></div>

        <div class="next-step">
            <span style="font-weight:bold; display:block; margin-bottom:6px; color:#fff;">âš¡ï¸ Next Action</span>
            <span id="res-anchor"></span>
        </div>

        <div style="margin-top:30px; display:flex; flex-direction:column; gap:10px;">
            <button class="action-btn" style="position:static; background:#1f6feb; box-shadow:none;" onclick="saveImage()">ğŸ“¸ ä¸‹è¼‰å¡ç‰‡</button>
            <button class="btn-outline" onclick="goBack()">â†©ï¸ è¿”å›ä¿®æ”¹å…§å®¹</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">è¨­å®šç›®æ¨™é …ç›®</div>
        <div id="settings-form">
            </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn-save" onclick="saveSettings()">å„²å­˜</button>
        </div>
    </div>
</div>

<script>
    const LOG_KEY = 'daily_retro_mobile_logs';
    const GOAL_KEY = 'daily_retro_goals';
    
    const DEFAULT_GOALS = [
        { label: "ğŸ‘€ å¯è¦–åŒ–ç›®æ¨™", sub: "æ›¸æœ¬æ”¾åœ¨æ¡Œä¸Š/é¡¯çœ¼è™•ï¼Ÿ" },
        { label: "âš“ï¸ åŸ·è¡ŒéŒ¨é»", sub: "æ—¢å®šå‹•ä½œå¾Œç«‹åˆ»é–‹å§‹ï¼Ÿ" },
        { label: "ğŸ“µ æ‹’çµ•æ‰‹æ©Ÿ", sub: "ä¼‘æ¯æ™‚é–“æ²’æ»‘æ‰‹æ©Ÿï¼Ÿ" },
        { label: "â³ å®Œæˆå¾®è¡Œå‹•", sub: "å°ˆæ³¨è‡³å°‘ 15 åˆ†é˜ï¼Ÿ" }
    ];

    const today = new Date();
    const dateStr = today.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
    document.getElementById('date-display').innerText = dateStr;

    renderHistory();
    loadGoals();

    // --- History / Navigation Logic (New!) ---

    // ç›£è½ç€è¦½å™¨çš„ã€Œä¸Šä¸€é ã€äº‹ä»¶
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.view === 'report') {
            showResultView(); // é€™ç¨®æƒ…æ³å¾ˆå°‘è¦‹ï¼Œé€šå¸¸æ˜¯å‰é€²æ™‚è§¸ç™¼
        } else {
            showInputView(); // å›åˆ°é è¨­ç‹€æ…‹
        }
    });

    function goBack() {
        // ä½¿ç”¨ç€è¦½å™¨çš„è¿”å›åŠŸèƒ½ï¼Œé€™æ¨£èƒ½ç¢ºä¿æ­·å²ç´€éŒ„å †ç–Šæ­£ç¢º
        window.history.back();
    }

    function showInputView() {
        document.getElementById('input-view').classList.remove('hidden');
        document.getElementById('result-view').classList.add('hidden');
    }

    function showResultView() {
        document.getElementById('result-view').classList.remove('hidden');
        document.getElementById('input-view').classList.add('hidden');
        window.scrollTo(0,0);
    }

    // --- Core Logic ---

    function vibrate() {
        if (navigator.vibrate) navigator.vibrate(10);
    }

    function toggleRow(row, checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) {
            row.classList.add('checked');
        } else {
            row.classList.remove('checked');
        }
        vibrate();
    }

    function generateReport() {
        vibrate();
        const c1 = document.getElementById('check-1').checked;
        const c2 = document.getElementById('check-2').checked;
        const c3 = document.getElementById('check-3').checked;
        const c4 = document.getElementById('check-4').checked;
        const summary = document.getElementById('summary-input').value.trim() || "ä»Šå¤©å°ˆæ³¨æ–¼åŸ·è¡Œè¨ˆç•«ã€‚";
        const anchor = document.getElementById('anchor-input').value.trim() || "ç„¡è¨ˆç•«";

        let score = 0;
        if(c1) score++;
        if(c2) score++;
        if(c3) score++;
        if(c4) score++;

        let rank = 'C';
        if(score === 4) rank = 'S';
        else if(score === 3) rank = 'A';
        else if(score === 2) rank = 'B';

        document.getElementById('res-date').innerText = dateStr;
        
        const rankEl = document.getElementById('res-rank');
        rankEl.innerText = rank;
        rankEl.className = `rank-badge rank-${rank}`;

        const circles = [];
        for(let i=0; i<4; i++) {
            circles.push(i < score ? "â—" : "â—‹");
        }
        document.getElementById('res-stars').innerText = circles.join(' ');

        document.getElementById('res-summary').innerText = summary;
        document.getElementById('res-anchor').innerText = anchor;

        // é—œéµä¿®æ”¹ï¼šæ¨å…¥æ­·å²ç´€éŒ„ï¼Œè®“ç€è¦½å™¨è¦ºå¾—é€²å…¥äº†ã€Œä¸‹ä¸€é ã€
        // é€™æ¨£æŒ‰ã€Œä¸Šä¸€é ã€æ™‚ï¼Œä¸æœƒé›¢é–‹ç¶²ç«™ï¼Œè€Œæ˜¯å›åˆ°ç·¨è¼¯ç‹€æ…‹
        window.history.pushState({ view: 'report' }, '', '#report');
        showResultView();

        saveLog({
            date: new Date().toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'}),
            timestamp: Date.now(),
            rank: rank,
            summary: summary
        });
    }

    // --- Goals & Settings ---

    function loadGoals() {
        let goals = JSON.parse(localStorage.getItem(GOAL_KEY));
        if (!goals) {
            goals = DEFAULT_GOALS;
            localStorage.setItem(GOAL_KEY, JSON.stringify(goals));
        }

        for (let i = 0; i < 4; i++) {
            document.getElementById(`label-${i+1}`).innerText = goals[i].label;
            document.getElementById(`sub-${i+1}`).innerText = goals[i].sub;
        }
    }

    function openSettings() {
        const modal = document.getElementById('settings-modal');
        const formDiv = document.getElementById('settings-form');
        let goals = JSON.parse(localStorage.getItem(GOAL_KEY) || JSON.stringify(DEFAULT_GOALS));
        
        let html = '';
        goals.forEach((goal, index) => {
            html += `
                <div class="modal-group">
                    <span class="modal-label">ç›®æ¨™ ${index + 1}</span>
                    <input type="text" class="modal-input" id="set-label-${index}" value="${goal.label}" placeholder="ä¸»æ¨™é¡Œ">
                    <input type="text" class="modal-input" id="set-sub-${index}" value="${goal.sub}" placeholder="å‰¯æ¨™é¡Œèªªæ˜">
                </div>
            `;
        });
        
        formDiv.innerHTML = html;
        modal.style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function saveSettings() {
        let newGoals = [];
        for (let i = 0; i < 4; i++) {
            const label = document.getElementById(`set-label-${i}`).value.trim();
            const sub = document.getElementById(`set-sub-${i}`).value.trim();
            if (!label) { alert('æ¨™é¡Œä¸èƒ½ç‚ºç©º'); return; }
            newGoals.push({ label, sub });
        }
        
        localStorage.setItem(GOAL_KEY, JSON.stringify(newGoals));
        loadGoals();
        closeSettings();
    }

    // --- Image Generation ---

    function saveImage() {
        vibrate();
        const element = document.getElementById('result-view');
        const btns = element.querySelectorAll('button');
        btns.forEach(b => b.style.display = 'none');

        html2canvas(element, { 
            backgroundColor: '#161b22',
            scale: 2 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Retro_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
            btns.forEach(b => b.style.display = 'flex');
        });
    }

    // --- History Data ---

    function saveLog(data) {
        let logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
        logs.unshift(data); 
        if(logs.length > 30) logs.pop();
        localStorage.setItem(LOG_KEY, JSON.stringify(logs));
        renderHistory();
    }

    function deleteLog(timestamp) {
        if(!confirm('åˆªé™¤ç´€éŒ„ï¼Ÿ')) return;
        let logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
        logs = logs.filter(l => l.timestamp !== timestamp);
        localStorage.setItem(LOG_KEY, JSON.stringify(logs));
        renderHistory();
    }

    function renderHistory() {
        const logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
        const container = document.getElementById('history-items');
        container.innerHTML = '';

        logs.forEach(log => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center; overflow:hidden;">
                    <div style="background:#21262d; border-radius:8px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-weight:900; color:${getRankColor(log.rank)}; margin-right:12px; flex-shrink:0;">${log.rank}</div>
                    <div style="overflow:hidden;">
                        <div style="color:#8b949e; font-size:0.8rem; margin-bottom:2px;">${log.date}</div>
                        <div style="color:#e6edf3; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${log.summary}</div>
                    </div>
                </div>
                <button class="del-btn" onclick="deleteLog(${log.timestamp})">âœ•</button>
            `;
            container.appendChild(div);
        });
    }

    function getRankColor(r) {
        if(r === 'S') return '#ffd700';
        if(r === 'A') return '#3fb950';
        if(r === 'B') return '#58a6ff';
        return '#8b949e';
    }
</script>

</body>
</html>
