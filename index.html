<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Quest v12: Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --primary: #2c3e50; --accent: #e67e22; 
            --habit: #f1c40f; --daily: #3498db; --todo: #e67e22;
            --bg-glass: rgba(255, 255, 255, 0.94);
            --nav-h: calc(65px + env(safe-area-inset-bottom, 20px));
            --radius: 12px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #1a1a1a; color: var(--primary); overflow: hidden; height: 100vh; }

        /* --- 2. è¦–è¦ºå±¤ (Canvas) --- */
        #world { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* --- 3. ä»‹é¢ä½ˆå±€ --- */
        .app-layout { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; z-index: 10; }
        
        /* é»æ“Šä¸Šæ–¹é€æ˜å€å¯çœ‹å¡” */
        .header-spacer { flex: 0 0 35vh; transition: flex 0.5s ease; cursor: pointer; position: relative; }
        .header-spacer::after { content: 'â–¼ é»æ“Šåˆ‡æ›è¦–è§’'; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.6); font-size: 0.8rem; opacity: 0; transition: 0.3s; }
        .header-spacer:hover::after { opacity: 1; }
        .header-spacer.collapsed { flex: 0 0 8vh; }

        .main-sheet {
            flex: 1; background: var(--bg-glass); backdrop-filter: blur(12px);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            padding: 20px; padding-bottom: calc(var(--nav-h) + 20px);
            overflow-y: auto; scroll-behavior: smooth; transition: transform 0.3s;
        }

        /* --- 4. é¦–é çµ„ä»¶ --- */
        /* æ•¸æ“šèˆ‡å¾½ç«  */
        .profile-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .stats-title { font-size: 0.7rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }
        .stats-number { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .badge-rack { display: flex; gap: 5px; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 20px; }
        .badge { width: 30px; height: 30px; border-radius: 50%; background: #ccc; display: flex; justify-content: center; align-items: center; font-size: 1rem; filter: grayscale(100%); opacity: 0.5; transition: 0.5s; }
        .badge.unlocked { filter: grayscale(0%); opacity: 1; background: white; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å†’éšªæŒ‡å¼•å¡ */
        .lore-card {
            background: #fff; border-left: 4px solid var(--daily); padding: 15px; border-radius: 12px;
            margin-bottom: 20px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .lore-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: var(--primary); display:flex; justify-content:space-between; }
        .lore-desc { font-size: 0.9rem; color: #666; white-space: pre-wrap; }

        /* ä¸‰æ¬„å¼çœ‹æ¿ */
        .grid-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .col-card { background: rgba(241, 242, 246, 0.8); padding: 10px; border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .col-header { 
            display: flex; justify-content: space-between; align-items: center; 
            font-weight: bold; color: #636e72; padding: 5px 5px 10px 5px; font-size: 0.85rem; text-transform: uppercase; 
        }
        
        /* æ¬„ä½å…§çš„å¿«é€Ÿæ–°å¢æŒ‰éˆ• (è§¸ç™¼å½ˆçª—) */
        .btn-col-add { 
            background: none; border: 2px dashed #ccc; border-radius: 8px; color: #999; 
            padding: 8px; margin-bottom: 10px; cursor: pointer; font-weight: bold; text-align: center; transition: 0.2s; 
        }
        .btn-col-add:hover { border-color: var(--primary); color: var(--primary); background: rgba(255,255,255,0.5); }

        /* --- 5. ä»»å‹™åˆ—è¡¨ --- */
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            background: white; padding: 12px; margin-bottom: 8px; border-radius: 10px;
            display: flex; align-items: flex-start; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        .type-habit { border-left-color: var(--habit); } 
        .type-daily { border-left-color: var(--daily); } 
        .type-todo { border-left-color: var(--todo); }
        
        .check-box { 
            width: 24px; height: 24px; background: #eee; border-radius: 6px; margin-right: 12px; 
            cursor: pointer; flex-shrink: 0; display: flex; justify-content: center; align-items: center; 
            color: white; font-weight: bold; font-size: 0.9rem; margin-top: 2px; transition: 0.2s;
        }
        .check-box:active { transform: scale(0.8); }
        .type-habit .check-box { background: var(--habit); } .type-habit .check-box::after { content: '+'; }
        
        .task-item.done { opacity: 0.6; background: #f8f9fa; }
        .task-item.done .task-title { text-decoration: line-through; color: #999; }
        .type-todo.done .check-box { background: var(--todo); } .type-todo.done .check-box::after { content: 'âœ”'; }
        .type-daily.done .check-box { background: #bdc3c7; }

        .task-content { flex: 1; min-width: 0; cursor: pointer; }
        .task-title { font-size: 0.95rem; font-weight: 600; line-height: 1.4; margin-bottom: 2px; }
        .task-desc { 
            font-size: 0.85rem; color: #888; display: none; margin-top: 5px; 
            padding-top: 5px; border-top: 1px dashed #eee; white-space: pre-wrap; line-height: 1.4;
        }
        .task-item.expanded .task-desc { display: block; } /* é»æ“Šå±•é–‹è©³æƒ… */

        /* --- 6. å…¶ä»–åˆ†é çµ„ä»¶ --- */
        .tab-content { display: none; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        .void-box { background: #2d3436; color: #dfe6e9; padding: 30px; border-radius: 16px; text-align: center; }
        .focus-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44,62,80,0.98); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; backdrop-filter: blur(10px); }

        h2 { font-size: 0.9rem; color: #95a5a6; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; display:flex; justify-content:space-between; }
        .btn { border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; transition: 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(44,62,80,0.3); }
        .btn-ghost { background: transparent; color: #aaa; border: 1px solid #ddd; font-size: 0.8rem; padding: 5px 10px; }
        .btn-danger { background: #ffeaa7; color: #d63031; border: 1px solid #d63031; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: white; font-size: 1rem; margin-bottom: 15px; }

        /* FAB & Modal */
        .fab { position: fixed; bottom: calc(var(--nav-h) + 25px); right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.6rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 100; cursor: pointer; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); } .fab:active { transform: rotate(90deg); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal { background: white; width: 100%; max-width: 420px; padding: 25px; border-radius: 16px; animation: popIn 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* è¼¸å…¥è¦–çª—æ¨£å¼ */
        .type-select { display: flex; gap: 8px; margin-bottom: 20px; }
        .type-opt { flex: 1; padding: 10px; text-align: center; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold; color: #888; transition: 0.2s; }
        .type-opt.active[data-t="habit"] { background: #fff8e1; color: var(--habit); border-color: var(--habit); }
        .type-opt.active[data-t="daily"] { background: #e3f2fd; color: var(--daily); border-color: var(--daily); }
        .type-opt.active[data-t="todo"] { background: #fff3e0; color: var(--todo); border-color: var(--todo); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding-top: 12px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); z-index: 90; }
        .nav-item { text-align: center; color: #bdc3c7; font-size: 0.7rem; cursor: pointer; width: 50px; }
        .nav-item i { display: block; font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }

        .toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #27ae60; color: white; padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 3000; transition: transform 0.5s; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <canvas id="world"></canvas>

    <div class="app-layout">
        <div class="header-spacer" id="tower-trigger" onclick="app.toggleView()"></div>
        
        <div class="main-sheet">
            
            <div id="tab-home" class="tab-content active">
                <div class="profile-header">
                    <div>
                        <div class="stats-title">ç”Ÿæ¶¯ç´¯ç© (LEGACY)</div>
                        <div class="stats-number" id="legacy-count">0</div>
                    </div>
                    <div class="badge-rack" id="badge-rack"></div>
                </div>

                <div class="lore-card" onclick="ui.modal('lore')">
                    <div class="lore-title"><span><i class="fas fa-scroll"></i> å†’éšªæŒ‡å¼•</span><i class="fas fa-edit"></i></div>
                    <div class="lore-desc" id="lore-text">...</div>
                </div>

                <div class="grid-board">
                    <div class="col-card">
                        <div class="col-header">
                            <span style="color:var(--habit)">ç¿’æ…£ Habits</span>
                            <i class="fas fa-trash btn-ghost" onclick="app.clear('habit')" title="æ¸…ç©ºç¿’æ…£"></i>
                        </div>
                        <div class="btn-col-add" onclick="ui.modal('add', 'habit')">+ æ–°å¢ç¿’æ…£</div>
                        <ul id="list-habit" class="task-list"></ul>
                    </div>
                    <div class="col-card">
                        <div class="col-header">
                            <span style="color:var(--daily)">æ¯æ—¥ Daily</span>
                            <i class="fas fa-sync-alt btn-ghost" onclick="app.clear('daily')" title="é‡ç½®ä»Šæ—¥"></i>
                        </div>
                        <div class="btn-col-add" onclick="ui.modal('add', 'daily')">+ æ–°å¢æ¯æ—¥</div>
                        <ul id="list-daily" class="task-list"></ul>
                    </div>
                    <div class="col-card">
                        <div class="col-header">
                            <span style="color:var(--todo)">å¾…è¾¦ Quest</span>
                            <i class="fas fa-archive btn-ghost" onclick="app.clear('todo')" title="å°å­˜å®Œæˆ"></i>
                        </div>
                        <div class="btn-col-add" onclick="ui.modal('add', 'todo')">+ æ–°å¢è¡Œå‹•</div>
                        <ul id="list-todo" class="task-list"></ul>
                    </div>
                </div>
            </div>

            <div id="tab-gacha" class="tab-content">
                <div style="text-align:center; padding:30px 0;">
                    <i class="fas fa-dice-d20" style="font-size:4rem; color:var(--primary); margin-bottom:20px;"></i><br>
                    <button class="btn btn-primary" onclick="app.spinGacha()">å‘½é‹æŒ‡å¼•</button>
                    <div id="gacha-result" style="display:none; margin-top:20px; border:2px solid var(--accent); padding:15px; border-radius:12px; background:#fff;">
                        <h3 id="res-title" style="margin:0; color:var(--accent)"></h3>
                        <p id="res-desc" style="color:#666; margin:5px 0 15px 0;"></p>
                        <button class="btn btn-primary" style="width:100%" onclick="app.acceptGacha()">æ¥å—æŒ‘æˆ°</button>
                    </div>
                </div>
                <h2>æŒ‘æˆ°æ±  <button class="btn-ghost" onclick="app.clear('pool')">æ¸…ç©º</button></h2>
                <div style="display:flex; gap:10px;">
                    <input id="pool-in" class="input-box" placeholder="æ–°æŒ‘æˆ°..." style="margin:0">
                    <button class="btn btn-primary" onclick="app.addPool()">+</button>
                </div>
                <ul id="list-pool" class="task-list" style="margin-top:15px;"></ul>
            </div>

            <div id="tab-void" class="tab-content">
                <h2>æƒ…ç·’ç¢ç´™æ©Ÿ</h2>
                <div class="void-box">
                    <p style="opacity:0.7; margin-top:0;">å¯«ä¸‹ç„¦æ…®ï¼Œç„¶å¾Œæ¯€æ»…å®ƒã€‚</p>
                    <textarea id="void-input" class="input-box" rows="4" style="background:rgba(255,255,255,0.1); color:white; border:none; resize:none;"></textarea>
                    <button class="btn btn-danger" style="width:100%;" onclick="app.shred()">æ¯€æ»…å¿µé ­</button>
                </div>
                <h2>å°ˆæ³¨çµç•Œ</h2>
                <div style="background:white; padding:20px; border-radius:12px; text-align:center;">
                    <i class="fas fa-stopwatch" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                    <p style="font-size:0.9rem; color:#666;">25 åˆ†é˜çµ•å°å°ˆæ³¨ã€‚</p>
                    <button class="btn btn-primary" style="width:100%;" onclick="app.startFocus()">é–‹å•Ÿçµç•Œ</button>
                </div>
            </div>

            <div id="tab-journal" class="tab-content">
                <h2>æ¯æ—¥æª¢è¨ <button class="btn-ghost" onclick="app.clear('journal')">æ¸…ç©º</button></h2>
                <div style="background:white; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:1.8rem; margin-bottom:15px;">
                        <span onclick="app.setMood('ğŸ˜­')" class="mood-btn">ğŸ˜­</span>
                        <span onclick="app.setMood('ğŸ˜')" class="mood-btn">ğŸ˜</span>
                        <span onclick="app.setMood('ğŸ™‚')" class="mood-btn">ğŸ™‚</span>
                        <span onclick="app.setMood('ğŸ¤©')" class="mood-btn">ğŸ¤©</span>
                    </div>
                    <textarea id="j-note" class="input-box" rows="3" placeholder="ä»Šæ—¥å¿ƒå¾—..."></textarea>
                    <button class="btn btn-primary" style="width:100%" onclick="app.saveJournal()">è¨˜éŒ„</button>
                </div>
                <ul id="list-journal" class="task-list"></ul>
            </div>

            <div id="tab-settings" class="tab-content">
                <h2>è³‡æ–™ç®¡ç†</h2>
                <button class="btn btn-primary" style="width:100%; margin-bottom:15px;" onclick="app.exportData()">å‚™ä»½è³‡æ–™ (JSON)</button>
                <button class="btn btn-danger" style="width:100%" onclick="app.reset()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                
                <h2 style="margin-top:30px;">ç´¯ç©æ­·å² <button class="btn-ghost" onclick="app.clear('legacy')">æ¸…ç©º</button></h2>
                <p style="font-size:0.8rem; color:#888;">é€™è£¡ç´€éŒ„è‘—æ‰€æœ‰è½‰åŒ–ç‚ºé«˜å¡”çš„è¡Œå‹•ã€‚</p>
            </div>

        </div>
    </div>

    <div class="fab" onclick="ui.modal('add')"><i class="fas fa-plus"></i></div>

    <div id="modal-add" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0;">æ–°å¢é …ç›®</h3>
            <input id="inp-title" class="input-box" placeholder="æ¨™é¡Œ (å¿…å¡«)">
            <textarea id="inp-desc" class="input-box" rows="3" placeholder="è©³ç´°å…§å®¹ (é¸å¡«)" style="resize:none;"></textarea>
            
            <div class="type-select">
                <div class="type-opt active" data-t="habit" onclick="ui.setType('habit', this)">ç¿’æ…£</div>
                <div class="type-opt" data-t="daily" onclick="ui.setType('daily', this)">æ¯æ—¥</div>
                <div class="type-opt" data-t="todo" onclick="ui.setType('todo', this)">å¾…è¾¦</div>
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="app.add()">æ–°å¢</button>
            <div style="text-align:center; margin-top:15px; color:#999; cursor:pointer;" onclick="document.getElementById('modal-add').style.display='none'">å–æ¶ˆ</div>
        </div>
    </div>

    <div id="modal-lore" class="modal-overlay">
        <div class="modal">
            <h3>ç·¨è¼¯èª“è¨€</h3>
            <textarea id="inp-lore" class="input-box" rows="6"></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="app.saveLore()">ä¿å­˜</button>
            <div style="text-align:center; margin-top:15px; color:#999; cursor:pointer;" onclick="document.getElementById('modal-lore').style.display='none'">å–æ¶ˆ</div>
        </div>
    </div>

    <div id="focus-overlay" class="focus-overlay">
        <div style="font-size:4rem; font-weight:100;" id="focus-timer">25:00</div>
        <p style="opacity:0.8;">å°ˆæ³¨ç•¶ä¸‹ Â· é é›¢ç´›æ“¾</p>
        <button class="btn btn-ghost" style="color:white; border-color:white; margin-top:30px;" onclick="app.stopFocus()">æ”¾æ£„</button>
    </div>

    <div id="toast" class="toast">
        <span style="font-size:1.5rem">ğŸ†</span>
        <div><div style="font-size:0.8rem; opacity:0.8">æˆå°±è§£é–</div><div style="font-weight:bold" id="toast-msg"></div></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="ui.tab('home', this)"><i class="fas fa-dungeon"></i>è–æ®¿</div>
        <div class="nav-item" onclick="ui.tab('gacha', this)"><i class="fas fa-dice"></i>å‘½é‹</div>
        <div class="nav-item" onclick="ui.tab('void', this)"><i class="fas fa-ghost"></i>æ·¨åŒ–</div>
        <div class="nav-item" onclick="ui.tab('journal', this)"><i class="fas fa-book-open"></i>æ—¥èªŒ</div>
        <div class="nav-item" onclick="ui.tab('settings', this)"><i class="fas fa-cog"></i>è¨­å®š</div>
    </nav>

    <script>
        /* --- 1. SOUND (8-bit) --- */
        const sfx = {
            ctx: null, init(){ if(!this.ctx) this.ctx=new(window.AudioContext||window.webkitAudioContext)(); },
            beep(f,t,d){
                if(!this.ctx) this.init(); if(this.ctx.state==='suspended') this.ctx.resume();
                const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.type=t; o.frequency.value=f; g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+d);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d);
            },
            click(){this.beep(800,'sine',0.05)}, win(){[440,554,659].forEach((f,i)=>setTimeout(()=>this.beep(f,'square',0.1),i*80))}, trash(){this.beep(150,'sawtooth',0.2)}
        };

        /* --- 2. VISUALS (Particles + Sky) --- */
        const vis = {
            cvs: document.getElementById('world'), ctx: document.getElementById('world').getContext('2d'),
            particles: [],
            init() { window.addEventListener('resize', ()=>this.draw()); this.draw(); this.loop(); },
            spawn(x,y,c){ for(let i=0;i<12;i++) this.particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1,c}); },
            draw() {
                const w=this.cvs.width=window.innerWidth, h=this.cvs.height=window.innerHeight;
                const ctx=this.ctx, count=store.db.legacy;
                // Sky
                const hr=new Date().getHours(), isNight=hr<6||hr>=18;
                const grad=ctx.createLinearGradient(0,0,0,h);
                grad.addColorStop(0,isNight?'#0f2027':'#89f7fe'); grad.addColorStop(1,isNight?'#2c3e50':'#66a6ff');
                ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
                // Tower
                const bw=40, bh=20, cols=Math.ceil(w/bw), startY=h*0.9;
                let drawn=0, row=0;
                ctx.fillStyle='#95a5a6'; ctx.strokeStyle='rgba(255,255,255,0.4)';
                while(drawn<count){
                    let inRow=Math.min(cols, count-drawn);
                    for(let i=0; i<inRow; i++){
                        ctx.fillRect((w-(inRow*bw))/2+i*bw, startY-(row*bh)-bh, bw, bh);
                        ctx.strokeRect((w-(inRow*bw))/2+i*bw, startY-(row*bh)-bh, bw, bh);
                    }
                    drawn+=inRow; row++;
                }
                // Particles
                for(let i=this.particles.length-1; i>=0; i--){
                    let p=this.particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life-=0.05;
                    ctx.fillStyle=p.c; ctx.globalAlpha=p.life; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
                    if(p.life<=0) this.particles.splice(i,1);
                }
                ctx.globalAlpha=1;
            },
            loop(){ this.draw(); requestAnimationFrame(()=>this.loop()); }
        };

        /* --- 3. DATA STORE --- */
        const store = {
            db: JSON.parse(localStorage.getItem('lqe_v12')) || { tasks: [], legacy: 0, journals: [], pool: [{t:"æ·±å‘¼å¸",d:"3æ¬¡"}], lore: "è¨­å®šç›®æ¨™...", lastLogin: Date.now() },
            save() { localStorage.setItem('lqe_v12', JSON.stringify(this.db)); app.render(); app.checkBadges(); },
            checkReset() {
                const today = new Date().toDateString();
                if(today !== new Date(this.db.lastLogin).toDateString()) {
                    this.db.tasks.forEach(t=>{ if(t.type==='daily') t.done=false; });
                    this.db.lastLogin = Date.now(); this.save();
                }
            }
        };

        /* --- 4. APP LOGIC --- */
        let addType = 'habit', currentMood = '';
        const badges = [{l:10,i:'ğŸŒ±',t:'åˆå­¸è€…'},{l:50,i:'ğŸ”¨',t:'ç¯‰å¡”è€…'},{l:100,i:'ğŸ°',t:'å ¡å£˜'},{l:500,i:'ğŸ‘‘',t:'åœ‹ç‹'}];

        const app = {
            init() {
                if(store.db.tasks.length===0) {
                    store.db.tasks=[{id:1,type:'habit',title:'å–æ°´',desc:'ä¿æŒæ°´åˆ†',done:false},{id:2,type:'daily',title:'é‹å‹•',desc:'30åˆ†',done:false},{id:3,type:'todo',title:'è¨­å®šAPP',desc:'ç†Ÿæ‚‰',done:false}];
                    store.save();
                }
                store.checkReset(); this.render(); vis.init(); this.checkBadges(true);
            },
            render() {
                document.getElementById('legacy-count').innerText = store.db.legacy;
                document.getElementById('lore-text').innerText = store.db.lore;
                document.getElementById('inp-lore').value = store.db.lore;
                
                ['habit','daily','todo'].forEach(type => {
                    const ul = document.getElementById('list-'+type); ul.innerHTML='';
                    store.db.tasks.forEach(t => {
                        if(t.type === type) {
                            if(type==='todo' && t.done) return; 
                            ul.innerHTML += `
                            <li class="task-item type-${t.type} ${t.done?'done':''}" onclick="this.classList.toggle('expanded')">
                                <div class="check-box" onclick="event.stopPropagation(); app.check('${t.id}', event)"></div>
                                <div class="task-content"><div class="task-title">${t.title}</div><div class="task-desc">${t.desc||''}</div></div>
                                <i class="fas fa-trash" style="color:#ddd;padding:5px;" onclick="event.stopPropagation(); app.del('${t.id}')"></i>
                            </li>`;
                        }
                    });
                });
                ui.renderList('list-pool', store.db.pool, i=>`<b>${i.t}</b> <small>${i.d}</small>`);
                ui.renderList('list-journal', store.db.journals, i=>`<small>${i.date} ${i.mood||''}</small><br>${i.text}`);
            },
            checkBadges(silent) {
                const r=document.getElementById('badge-rack'); r.innerHTML='';
                badges.forEach(b => {
                    const unlk = store.db.legacy >= b.l;
                    r.innerHTML += `<div class="badge ${unlk?'unlocked':''}">${b.i}</div>`;
                    if(!silent && store.db.legacy === b.l) ui.toast(b.t, b.i);
                });
            },
            add() {
                const t=document.getElementById('inp-title').value, d=document.getElementById('inp-desc').value;
                if(t) { store.db.tasks.push({id:Date.now().toString(36), type:addType, title:t, desc:d, done:false}); store.save(); document.getElementById('modal-add').style.display='none'; document.getElementById('inp-title').value=''; document.getElementById('inp-desc').value=''; sfx.click(); }
            },
            check(id, e) {
                const t = store.db.tasks.find(x=>x.id==id);
                if(t) {
                    if(e) vis.spawn(e.clientX, e.clientY, '#f1c40f');
                    if(t.type==='habit') { store.db.legacy++; sfx.win(); }
                    else { 
                        t.done=!t.done; 
                        if(t.type==='todo' && t.done) { store.db.legacy++; sfx.win(); } // Todo adds legacy on done
                        else sfx.click(); 
                    }
                    store.save();
                }
            },
            del(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { store.db.tasks=store.db.tasks.filter(x=>x.id!=id); store.save(); sfx.trash(); } },
            clear(type) {
                if(!confirm('æ¸…ç©ºï¼Ÿ')) return;
                sfx.trash();
                if(type==='todo') {
                    const done = store.db.tasks.filter(t=>t.type==='todo' && t.done);
                    store.db.legacy += done.length;
                    store.db.tasks = store.db.tasks.filter(t=>!(t.type==='todo'&&t.done));
                    vis.spawn(window.innerWidth/2, window.innerHeight/2, '#f1c40f');
                } else if(['habit','daily'].includes(type)) {
                    store.db.tasks=store.db.tasks.filter(t=>t.type!==type);
                } else if(type==='pool') store.db.pool=[];
                else if(type==='journal') store.db.journals=[];
                else if(type==='legacy') store.db.legacy = 0;
                store.save();
            },
            saveLore() { store.db.lore=document.getElementById('inp-lore').value; store.save(); document.getElementById('modal-lore').style.display='none'; },
            addPool() { const v=document.getElementById('pool-in').value; if(v){ store.db.pool.push({t:v,d:''}); store.save(); document.getElementById('pool-in').value=''; } },
            spinGacha() { 
                if(!store.db.pool.length) return alert('ç©ºæ± ');
                const i = store.db.pool[Math.floor(Math.random()*store.db.pool.length)];
                this.tempGacha = i;
                document.getElementById('res-title').innerText = i.t; document.getElementById('res-desc').innerText = i.d;
                document.getElementById('gacha-result').style.display='block'; sfx.win();
            },
            acceptGacha() { if(this.tempGacha){ store.db.tasks.push({id:Date.now().toString(36), type:'todo', title:this.tempGacha.t, desc:'å‘½é‹æŒ‘æˆ°', done:false}); store.save(); document.getElementById('gacha-result').style.display='none'; ui.tab('home',document.querySelectorAll('.nav-item')[0]); } },
            shred() { const e=document.getElementById('void-input'); if(e.value){ sfx.trash(); vis.spawn(window.innerWidth/2, window.innerHeight/2, '#333'); e.style.transition='0.5s'; e.style.transform='scale(0)'; setTimeout(()=>{e.value='';e.style.transform='none'},500); } },
            startFocus() {
                document.getElementById('focus-overlay').style.display='flex';
                let s=25*60; this.tmr=setInterval(()=>{ s--; document.getElementById('focus-timer').innerText=`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; if(s<=0){clearInterval(this.tmr);sfx.win();alert('å®Œæˆ');this.stopFocus();} },1000);
            },
            stopFocus(){ clearInterval(this.tmr); document.getElementById('focus-overlay').style.display='none'; },
            setMood(m){ currentMood=m; sfx.click(); document.querySelectorAll('.mood-btn').forEach(b=>b.style.opacity=b.innerText===m?'1':'0.5'); },
            saveJournal(){ const t=document.getElementById('j-note').value; if(t||currentMood){ store.db.journals.unshift({date:new Date().toLocaleString(), mood:currentMood, text:t}); store.save(); document.getElementById('j-note').value=''; sfx.win(); } },
            exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(store.db)); a.download="sanctuary_data.json"; a.click(); },
            reset(){ if(confirm('è­¦å‘Šï¼šåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')){ localStorage.removeItem('lqe_v12'); location.reload(); } },
            toggleView() { document.querySelector('.header-spacer').classList.toggle('collapsed'); }
        };

        /* --- 5. UI HELPERS --- */
        const ui = {
            tab(id, el) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); document.querySelector('.fab').style.display=id==='home'?'flex':'none'; sfx.click(); },
            modal(id, type) { 
                document.getElementById('modal-'+id).style.display='flex'; 
                if(type) ui.setType(type, document.querySelector(`.type-opt[data-t="${type}"]`));
            },
            setType(t, el) { addType=t; document.querySelectorAll('.type-opt').forEach(e=>e.classList.remove('active')); el.classList.add('active'); },
            toast(t,i) { const el=document.getElementById('toast'); document.getElementById('toast-msg').innerText=t; el.querySelector('span').innerText=i; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000); },
            renderList(id, list, fn) { const ul=document.getElementById(id); ul.innerHTML=''; list.forEach(i=> ul.innerHTML+=`<li class="task-item"><div class="task-content">${fn(i)}</div></li>`); }
        };

        app.init();
    </script>
</body>
</html>
